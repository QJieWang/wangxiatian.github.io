<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Detectron2, WTJ">
    <meta name="description" content="Detectron20. 本文的基本信息本文写于2021年12月27日。12章往后的内容需要自己在实战中结合自己的理解重新编写，所以会继续修改。Detectron2将分为两个文章，一个是本文基于config另一个是cloab形式基于API的">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Detectron2 | WTJ</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="WTJ" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">WTJ</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">WTJ</div>
        <div class="logo-desc">
            
            个人的笔记
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('访问密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Detectron2</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
                                <span class="chip bg-color">深度学习</span>
                            </a>
                        
                            <a href="/tags/Detectron2/">
                                <span class="chip bg-color">Detectron2</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-12-30
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Detectron2"><a href="#Detectron2" class="headerlink" title="Detectron2"></a>Detectron2</h1><h2 id="0-本文的基本信息"><a href="#0-本文的基本信息" class="headerlink" title="0. 本文的基本信息"></a>0. 本文的基本信息</h2><p>本文写于2021年12月27日。12章往后的内容需要自己在实战中结合自己的理解重新编写，所以会继续修改。Detectron2将分为两个文章，一个是本文基于config另一个是cloab形式基于API的。</p>
<p>官网很重要，常看官网。</p>
<h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1. 介绍"></a>1. 介绍</h2><p>Detectron2 是Facebook AI Research提供的一款算法库，包含目标检测和分割。完全由PyTorch编写，可以用来学习与快速部署。</p>
<div align="center">
  <img src="https://user-images.githubusercontent.com/1381301/66535560-d3422200-eace-11e9-9123-5535d469db19.png">
</div>

<p>几个关键的链接</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2">官方Github链接</a></li>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/getting_started.html">官方教程</a></li>
</ul>
<h2 id="2-使用教程"><a href="#2-使用教程" class="headerlink" title="2. 使用教程"></a>2. 使用教程</h2><h3 id="2-1-在自己的电脑上安装"><a href="#2-1-在自己的电脑上安装" class="headerlink" title="2.1.  在自己的电脑上安装"></a>2.1.  在自己的电脑上安装</h3><h4 id="1-限制"><a href="#1-限制" class="headerlink" title="1. 限制"></a>1. 限制</h4><ul>
<li><code>Detectron2</code>只能在Linux和MacOS上运行</li>
<li><code>python</code>版本  ≥ 3.6</li>
<li><code>PyTorch</code>版本  ≥ 3.6，<code>toechvision</code>需要与PyTorch版本一致（正常都是一起装的）</li>
<li>建议安装<code>OpenCV</code>，很多样例教程与可视化都依赖它</li>
</ul>
<h4 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h4><p>提供两种安装方式，但是只有Linux有对应直接可用的预编译文件，同时每隔几个月<code>Detectron2</code>就有新版本，记得更新。</p>
<ul>
<li><p>自己编译（gcc &amp; g++ ≥ 5.4，同时推荐安装ninja可以加速编译）</p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">python -m pip install 'git+https://github.com/facebookresearch/detectron2.git'
# (add --user if you don't have permission)

# Or, to install it from a local clone:
git clone https://github.com/facebookresearch/detectron2.git
python -m pip install -e detectron2

# On macOS, you may need to prepend the above commands with a few environment variables:
CC=clang CXX=clang++ ARCHFLAGS="-arch x86_64" python -m pip install ...
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>每次重新安装PyTorch后都需要重新编译才可用</p>
</li>
</ul>
</li>
<li><p>官方预编译文件（只有Linux有）</p>
<ul>
<li><p>需要看好对应的<code>Torch</code>和<code>CUDA</code>版本选择安装，如果两者组合不在官方列表之内（官方教程中查看），就需要自己编译。</p>
</li>
<li><p>首先查看自己的python版本</p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># '1.9.0+cu111' 恰好在官方的支持之列</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>这里以<code>CUDA</code>11.1，<code>torch</code>1.9为例</p>
</li>
<li><pre class="line-numbers language-shell"><code class="language-shell">python -m pip install detectron2 -f https://dl.fbaipublicfiles.com/detectron2/wheels/cu111/torch1.9/index.html
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="2-2-在Colab与Docker使用"><a href="#2-2-在Colab与Docker使用" class="headerlink" title="2.2 在Colab与Docker使用"></a>2.2 在Colab与Docker使用</h3><p>Colab使用</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5">Detectron2 Tutorial.ipynb - Colaboratory (google.com)</a></li>
</ul>
<p>Docker使用</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/tree/main/docker">detectron2/docker at main · facebookresearch/detectron2 (github.com)</a></li>
</ul>
<p>两种方式都能避免在自己电脑上安装时出现的很多问题，即使在自己的电脑上也推荐使用Docker。</p>
<p>我自己Docker用的比较多所以就详细介绍一下Docker的安装与使用，一些缺点：之前安装过Docker与CUDA的依赖，所以这里比较简单，如果出现不能使用CUDA的情况，还是要自行百度的。</p>
<ul>
<li><ol>
<li><p>克隆官方仓库</p>
<pre class="line-numbers language-shell"><code class="language-shell">git clone https://github.com/facebookresearch/detectron2.git
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>进入<code>Detectron2</code>下的Docker目录</p>
<pre class="line-numbers language-shell"><code class="language-shell">cd docker
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>编译<code>Docker</code></p>
<pre class="line-numbers language-shell"><code class="language-shell"># Docker是一层一层的下载，速度看个人，如果很慢可以百度添加阿里docker源
docker build --build-arg USER_ID=$UID -t detectron2:v0 .
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>启动<code>Docker</code>并挂载文件夹</p>
<pre class="line-numbers language-shell"><code class="language-shell">docker run --gpus all -it --shm-size=8gb --env="DISPLAY" --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" --name=detectron2 detectron2:v0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>开启图像显示</p>
<pre class="line-numbers language-shell"><code class="language-shell">xhost +local:`docker inspect --format='{{ .Config.Hostname }}' detectron2`
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>个人的一些建议</p>
<p>推荐vscode远程连接<code>docker</code>镜像，可以自行百度，实现远程开发。</p>
<ol>
<li>安装插件<code>Remote Development</code>，会自动安装三个插件,详细看插件介绍。</li>
<li>vscode连接远程电脑（如果Docker在本机上就不需要了），一定要配置SSH免密登录，不然断连的体验会很糟糕。</li>
<li>vscode连接远程电脑里的Docker</li>
</ol>
</li>
</ol>
</li>
</ul>
<h2 id="3-开始食用-smirk"><a href="#3-开始食用-smirk" class="headerlink" title="3. 开始食用 :smirk:"></a>3. 开始食用 <span class="github-emoji"><span>😏</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h2><h3 id="1-Demo"><a href="#1-Demo" class="headerlink" title="1.Demo"></a>1.Demo</h3><p>以<code>Detectron2</code>项目文件夹为根目录,可以选择的模型在<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/MODEL_ZOO.md">detectron2/MODEL_ZOO.md</a>目录下有详细的介绍，这里只运行官方的demo</p>
<pre class="line-numbers language-shell"><code class="language-shell">cd demo/
python demo.py --config-file ../configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml --input input1.jpg input2.jpg [--other-options] --opts MODEL.WEIGHTS detectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl
# 运行的会比较慢，需要下载官方与训练权重
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="2-命令行训练与评估"><a href="#2-命令行训练与评估" class="headerlink" title="2. 命令行训练与评估"></a>2. 命令行训练与评估</h3><p>在tool目录下有两个函数文件<code>plain_train_net.py</code>和<code>train_net.py</code>。这两个函数能训练<code>Detectron2</code>中的所有配置网络。这两个函数文件可以作为参考，编写用户自己的训练脚本。<br><code>plain_train_net.py</code>和<code>train_net.py</code>的区别：<code>plain_train_net.py</code>支持更少的特性，更少的抽象类，所以修改起来更容易。</p>
<p>想要评估网络效果只需要添加<code>--eval-only</code>,更多的参数选择可以查看函数文件或者使用<code>./train_net.py -h</code></p>
<h3 id="3-函数API使用"><a href="#3-函数API使用" class="headerlink" title="3. 函数API使用"></a>3. 函数API使用</h3><ol>
<li>参考官方的Colab<a target="_blank" rel="noopener" href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5">Detectron2 Tutorial.ipynb - Colaboratory (google.com)</a></li>
<li>更多基于detectron2的项目参考<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/tree/main/projects">detectron2/projects at main · facebookresearch/detectron2 (github.com)</a>（但是这些项目的一些特性与稳定性不一定有Detectron2那么高）</li>
</ol>
<h2 id="4-构建内置数据集"><a href="#4-构建内置数据集" class="headerlink" title="4. 构建内置数据集"></a>4. 构建内置数据集</h2><p>可以通过<code>DasetCatalong</code>或者<code>MetadataCatalog</code>访问数据，详细参考<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/datasets.html">Custom Datasets</a>。同时<code>Detectron2</code>也内置了一些数据集,包括</p>
<ul>
<li>COCO</li>
<li>lvis</li>
<li>cityscapes</li>
<li>VOC20{07,12}</li>
</ul>
<p>可以通过命令，指定内置数据集的地址</p>
<pre class="line-numbers language-shell"><code class="language-shell"># /path/to/datasets默认为./datasets
export DETECTRON2_DATASETS=/path/to/datasets
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="5-拓展Detectron2的功能"><a href="#5-拓展Detectron2的功能" class="headerlink" title="5. 拓展Detectron2的功能"></a>5. 拓展<code>Detectron2</code>的功能</h2><p>深度学习的研究意味着做新的工作，但是这就带来一个新的挑战，如何在代码抽象与具体实现中平衡。如果抽象层次很高，那么使用者就能利用框架简单的做很多的事，但是这也意味着很难实现研究者的创意与突破框架。就像是扫帚和吸尘器，虽然吸尘器很好用，解放了人力，但是想用吸尘器赶老鼠是不可能的（做一些创新），还是扫帚更好用。</p>
<p>在<code>Detectron2</code>中，通过提供两种接口来平衡，分别是<strong>配置接口</strong>与<strong>具体参数</strong></p>
<ul>
<li><p>配置接口（config argument） </p>
<ul>
<li><p>大家只需要在专家创建的<code>yml</code>文件的基础上进行修改，就能实现自己想要的效果，很多参数都有默认值，不了解都不会有影响，只需要记得常用的。详细可以参考<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/configs.html">Yacs Configs</a>。</p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># load proper yaml config file, then</span>
model <span class="token operator">=</span> build_model<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>具体参数（explicit arguments）</p>
<ul>
<li><p>每一个函数都是整个系统的一部分，使用者需要了解每一个参数的意义，并将这些函数拼装成一整个系统。详细可以参考<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/lazyconfigs.html">LazyConfig system</a></p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python">model <span class="token operator">=</span> GeneralizedRCNN<span class="token punctuation">(</span>
    backbone<span class="token operator">=</span>FPN<span class="token punctuation">(</span>
        ResNet<span class="token punctuation">(</span>
            BasicStem<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> norm<span class="token operator">=</span><span class="token string">"FrozenBN"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ResNet<span class="token punctuation">.</span>make_default_stages<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> stride_in_1x1<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> norm<span class="token operator">=</span><span class="token string">"FrozenBN"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            out_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"res2"</span><span class="token punctuation">,</span> <span class="token string">"res3"</span><span class="token punctuation">,</span> <span class="token string">"res4"</span><span class="token punctuation">,</span> <span class="token string">"res5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">"res2"</span><span class="token punctuation">,</span> <span class="token string">"res3"</span><span class="token punctuation">,</span> <span class="token string">"res4"</span><span class="token punctuation">,</span> <span class="token string">"res5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token number">256</span><span class="token punctuation">,</span>
        top_block<span class="token operator">=</span>LastLevelMaxPool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    proposal_generator<span class="token operator">=</span>RPN<span class="token punctuation">(</span>
        in_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"p2"</span><span class="token punctuation">,</span> <span class="token string">"p3"</span><span class="token punctuation">,</span> <span class="token string">"p4"</span><span class="token punctuation">,</span> <span class="token string">"p5"</span><span class="token punctuation">,</span> <span class="token string">"p6"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        head<span class="token operator">=</span>StandardRPNHead<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_anchors<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        anchor_generator<span class="token operator">=</span>DefaultAnchorGenerator<span class="token punctuation">(</span>
            sizes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            aspect_ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            offset<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        anchor_matcher<span class="token operator">=</span>Matcher<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        box2box_transform<span class="token operator">=</span>Box2BoxTransform<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        batch_size_per_image<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        positive_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
        pre_nms_topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        post_nms_topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    roi_heads<span class="token operator">=</span>StandardROIHeads<span class="token punctuation">(</span>
        num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
        batch_size_per_image<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
        positive_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
        proposal_matcher<span class="token operator">=</span>Matcher<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        box_in_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"p2"</span><span class="token punctuation">,</span> <span class="token string">"p3"</span><span class="token punctuation">,</span> <span class="token string">"p4"</span><span class="token punctuation">,</span> <span class="token string">"p5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        box_pooler<span class="token operator">=</span>ROIPooler<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ROIAlignV2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        box_head<span class="token operator">=</span>FastRCNNConvFCHead<span class="token punctuation">(</span>
            ShapeSpec<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conv_dims<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fc_dims<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        box_predictor<span class="token operator">=</span>FastRCNNOutputLayers<span class="token punctuation">(</span>
            ShapeSpec<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            test_score_thresh<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>
            box2box_transform<span class="token operator">=</span>Box2BoxTransform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_in_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"p2"</span><span class="token punctuation">,</span> <span class="token string">"p3"</span><span class="token punctuation">,</span> <span class="token string">"p4"</span><span class="token punctuation">,</span> <span class="token string">"p5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        mask_pooler<span class="token operator">=</span>ROIPooler<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ROIAlignV2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_head<span class="token operator">=</span>MaskRCNNConvUpsampleHead<span class="token punctuation">(</span>
            ShapeSpec<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
            conv_dims<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    pixel_mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.530</span><span class="token punctuation">,</span> <span class="token number">116.280</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pixel_std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    input_format<span class="token operator">=</span><span class="token string">"BGR"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>配置与函数的结合</p>
<ul>
<li><p>一小部分被<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.configurable">@configurable</a>修饰的函数与类，既可以被当成配置使用，也可以被当作函数接口使用。</p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python">model <span class="token operator">=</span> GeneralizedRCNN<span class="token punctuation">(</span>
  cfg<span class="token punctuation">,</span>
  roi_heads<span class="token operator">=</span>StandardROIHeads<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> batch_size_per_image<span class="token operator">=</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  pixel_std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">57.0</span><span class="token punctuation">,</span> <span class="token number">57.0</span><span class="token punctuation">,</span> <span class="token number">57.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<p>如果你像实现基本功能，可以参看<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/getting_started.html">Beginner’s Tutorial</a>，如果像将<code>Detectron2</code>用到自己的项目中就需要查看</p>
<ul>
<li>Detectron2 includes a few standard datasets. To use custom ones, see <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/datasets.html">Use Custom Datasets</a>.</li>
<li>Detectron2 contains the standard logic that creates a data loader for training/testing from a dataset, but you can write your own as well. See <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/data_loading.html">Use Custom Data Loaders</a>.</li>
<li>Detectron2 implements many standard detection models, and provide ways for you to overwrite their behaviors. See <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/models.html">Use Models</a> and <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/write-models.html">Write Models</a>.</li>
<li>Detectron2 provides a default training loop that is good for common training tasks. You can customize it with hooks, or write your own loop instead. See <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/training.html">training</a>.</li>
</ul>
<h2 id="6-自定义数据集"><a href="#6-自定义数据集" class="headerlink" title="6. 自定义数据集"></a>6. 自定义数据集</h2><h3 id="6-1-注册数据集"><a href="#6-1-注册数据集" class="headerlink" title="6.1 注册数据集"></a>6.1 注册数据集</h3><p>官网也为<code>register</code>这个词感到<span class="github-emoji"><span>😅</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>，其实就是搭建数据管道，让<code>Detectron2</code>知道如何读取数据。具体就是实现一个函数，函数需要能够读取数据中的每一个数据，并将这个函数与指定方法绑定。</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">my_dataset_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> list<span class="token punctuation">[</span>dict<span class="token punctuation">]</span> <span class="token keyword">in</span> the following format <span class="token comment" spellcheck="true"># 需要实现的方法</span>

<span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> DatasetCatalog
DatasetCatalog<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">,</span> my_dataset_function<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># later, to access the data:</span>
data<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span> <span class="token operator">=</span> DatasetCatalog<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># 函数绑定</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-标准数据字典"><a href="#6-2-标准数据字典" class="headerlink" title="6.2 标准数据字典"></a>6.2 标准数据字典</h3><p>对于CV中常见的任务目标检测、实例/语义/全景分割、关键点检测，数据的格式与COCO的格式很相近，所有的数据存在一个list列表中，每个列表成员都是一个字典，总体表示为<code>list[dict]</code>。一般的字典数据与任务有关，可以参考</p>
<table>
<thead>
<tr>
<th>Task</th>
<th>Fields</th>
</tr>
</thead>
<tbody><tr>
<td>Common</td>
<td>file_name, height, width, image_id</td>
</tr>
<tr>
<td>Instance detection/segmentation</td>
<td>annotations</td>
</tr>
<tr>
<td>Semantic segmentation</td>
<td>sem_seg_file_name</td>
</tr>
<tr>
<td>Panoptic segmentation</td>
<td>pan_seg_file_name, segments_info</td>
</tr>
</tbody></table>
<ul>
<li><p><code>file_name</code>: the full path to the image file.</p>
</li>
<li><p><code>height</code>, <code>width</code>: integer. The shape of the image.</p>
</li>
<li><p><code>image_id</code> (str or int): a unique id that identifies this image. Required by many evaluators to identify the images, but a dataset may use it for different purposes.</p>
</li>
<li><p><code>annotations</code> (list[dict]): Required by <strong>instance detection/segmentation or keypoint detection</strong> tasks. Each dict corresponds to annotations of one instance in this image, and may contain the following keys:</p>
<ul>
<li><p><code>bbox</code> (list[float], required): list of 4 numbers representing the bounding box of the instance.</p>
</li>
<li><p><code>bbox_mode</code> (int, required): the format of bbox. It must be a member of <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/structures.html#detectron2.structures.BoxMode">structures.BoxMode</a>. Currently supports: <code>BoxMode.XYXY_ABS</code>, <code>BoxMode.XYWH_ABS</code>.</p>
</li>
<li><p><code>category_id</code> (int, required): an integer in the range [0, num_categories-1] representing the category label. The value num_categories is reserved to represent the “background” category, if applicable.</p>
</li>
<li><p><code>segmentation</code> (list[list[float]] or dict): the segmentation mask of the instance.</p>
<ul>
<li>If <code>list[list[float]]</code>, it represents a list of polygons, one for each connected component of the object. Each <code>list[float]</code> is one simple polygon in the format of <code>[x1, y1, ..., xn, yn]</code> (n≥3). The Xs and Ys are absolute coordinates in unit of pixels.</li>
<li>If <code>dict</code>, it represents the per-pixel segmentation mask in COCO’s compressed RLE format. The dict should have keys “size” and “counts”. You can convert a uint8 segmentation mask of 0s and 1s into such dict by <code>pycocotools.mask.encode(np.asarray(mask, order="F"))</code>. <code>cfg.INPUT.MASK_FORMAT</code> must be set to <code>bitmask</code> if using the default data loader with such format.</li>
</ul>
</li>
<li><p><code>keypoints</code> (list[float]): in the format of [x1, y1, v1,…, xn, yn, vn]. v[i] means the <a target="_blank" rel="noopener" href="http://cocodataset.org/#format-data">visibility</a> of this keypoint. <code>n</code> must be equal to the number of keypoint categories. The Xs and Ys are absolute real-value coordinates in range [0, W or H].</p>
<p>(Note that the keypoint coordinates in COCO format are integers in range [0, W-1 or H-1], which is different from our standard format. Detectron2 adds 0.5 to COCO keypoint coordinates to convert them from discrete pixel indices to floating point coordinates.)</p>
</li>
<li><p><code>iscrowd</code>: 0 (default) or 1. Whether this instance is labeled as COCO’s “crowd region”. Don’t include this field if you don’t know what it means.</p>
</li>
</ul>
<p>If <code>annotations</code> is an empty list, it means the image is labeled to have no objects. Such images will by default be removed from training, but can be included using <code>DATALOADER.FILTER_EMPTY_ANNOTATIONS</code>.</p>
</li>
<li><p><code>sem_seg_file_name</code> (str): The full path to the semantic segmentation ground truth file. It should be a grayscale image whose pixel values are integer labels.</p>
</li>
<li><p><code>pan_seg_file_name</code> (str): The full path to panoptic segmentation ground truth file. It should be an RGB image whose pixel values are integer ids encoded using the <a target="_blank" rel="noopener" href="https://github.com/cocodataset/panopticapi/">panopticapi.utils.id2rgb</a> function. The ids are defined by <code>segments_info</code>. If an id does not appear in <code>segments_info</code>, the pixel is considered unlabeled and is usually ignored in training &amp; evaluation.</p>
</li>
<li><p><code>segments_info</code> (list[dict]): defines the meaning of each id in panoptic segmentation ground truth. Each dict has the following keys:</p>
<ul>
<li><code>id</code> (int): integer that appears in the ground truth image.</li>
<li><code>category_id</code> (int): an integer in the range [0, num_categories-1] representing the category label.</li>
<li><code>iscrowd</code>: 0 (default) or 1. Whether this instance is labeled as COCO’s “crowd region”.</li>
</ul>
</li>
</ul>
<p>这没什么好解释的了……</p>
<p>如果像训练一个Fast R-CNN还需要提供格外的数据</p>
<ul>
<li><code>proposal_boxes</code> (array): 2D numpy array with shape (K, 4) representing K precomputed proposal boxes for this image.</li>
<li><code>proposal_objectness_logits</code> (array): numpy array with shape (K, ), which corresponds to the objectness logits of proposals in ‘proposal_boxes’.</li>
<li><code>proposal_bbox_mode</code> (int): the format of the precomputed proposal bbox. It must be a member of <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/structures.html#detectron2.structures.BoxMode">structures.BoxMode</a>. Default is <code>BoxMode.XYXY_ABS</code>.</li>
</ul>
<p>总的说来，具体任务的数据基本是通用的，如果有例外，自己添加即可。</p>
<h3 id="6-3-为新任务自定义数据字典"><a href="#6-3-为新任务自定义数据字典" class="headerlink" title="6.3 为新任务自定义数据字典"></a>6.3 为新任务自定义数据字典</h3><p>这可能需要修改后续的处理，但是在数据部分，只需要修改为<code>dataloader</code>写一个新的<code>mapper</code>函数。需要注意的是数据字典完整的保存在内存中，不要写太多的无用信息或加载太大的信息作为标签。对于一些共享的信息，使用<code>Metadata</code>。<br>注意事项汇总</p>
<ol>
<li>数据字典加载在内存中</li>
<li>不要加载太多，太大的信息</li>
<li>共享的信息，用<code>Metadata</code></li>
</ol>
<h3 id="6-4-数据集中的Metadata"><a href="#6-4-数据集中的Metadata" class="headerlink" title="6.4 数据集中的Metadata"></a>6.4 数据集中的<code>Metadata</code></h3><p>每个数据集都包含一些元信息（metadata），可以通过<code>MetadataCatalog.get(dataset_name).some_metadata</code>获取，以键值对的形式保存数据，常见的信息：类的名称，颜色，文件的根目录等。这些信息被用来当做函数参数，评价指标，可视化信息以及记载日志等。</p>
<p>一般流程为，先通过<code>DatasetCatalog.register</code>注册一个新的数据集，再通过<code>MetadataCatalog.get(dataset_name).some_key = some_value</code>添加元信息</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> MetadataCatalog
MetadataCatalog<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>thing_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"person"</span><span class="token punctuation">,</span> <span class="token string">"dog"</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>下表是在<code>Detectron2</code>项目中常用的元信息，如果不遵循以下建议，可能会导致一些功能特性无法使用。（辕信息的键值对是高度自由定义的，所以需要你与官方命名保持一致，方便使用官方的功能）</p>
<ul>
<li><code>thing_classes</code> (list[str]): Used by all instance detection/segmentation tasks. A list of names for each instance/thing category. If you load a COCO format dataset, it will be automatically set by the function <code>load_coco_json</code>.</li>
<li><code>thing_colors</code> (list[tuple(r, g, b)]): Pre-defined color (in [0, 255]) for each thing category. Used for visualization. If not given, random colors will be used.</li>
<li><code>stuff_classes</code> (list[str]): Used by semantic and panoptic segmentation tasks. A list of names for each stuff category.</li>
<li><code>stuff_colors</code> (list[tuple(r, g, b)]): Pre-defined color (in [0, 255]) for each stuff category. Used for visualization. If not given, random colors are used.</li>
<li><code>ignore_label</code> (int): Used by semantic and panoptic segmentation tasks. Pixels in ground-truth annotations with this category label should be ignored in evaluation. Typically these are “unlabeled” pixels.</li>
<li><code>keypoint_names</code> (list[str]): Used by keypoint detection. A list of names for each keypoint.</li>
<li><code>keypoint_flip_map</code> (list[tuple[str]]): Used by keypoint detection. A list of pairs of names, where each pair are the two keypoints that should be flipped if the image is flipped horizontally during augmentation.</li>
<li><code>keypoint_connection_rules</code>: list[tuple(str, str, (r, g, b))]. Each tuple specifies a pair of keypoints that are connected and the color (in [0, 255]) to use for the line between them when visualized.</li>
</ul>
<p>一些额外的信息是针对特定数据集（比如COCO）的验证过程：</p>
<ul>
<li><code>thing_dataset_id_to_contiguous_id</code> (dict[int-&gt;int]): Used by all instance detection/segmentation tasks in the COCO format. A mapping from instance class ids in the dataset to contiguous ids in range [0, #class). Will be automatically set by the function <code>load_coco_json</code>.</li>
<li><code>stuff_dataset_id_to_contiguous_id</code> (dict[int-&gt;int]): Used when generating prediction json files for semantic/panoptic segmentation. A mapping from semantic segmentation class ids in the dataset to contiguous ids in [0, num_categories). It is useful for evaluation only.</li>
<li><code>json_file</code>: The COCO annotation json file. Used by COCO evaluation for COCO-format datasets.</li>
<li><code>panoptic_root</code>, <code>panoptic_json</code>: Used by COCO-format panoptic evaluation.</li>
<li><code>evaluator_type</code>: Used by the builtin main training script to select evaluator. Don’t use it in a new training script. You can just provide the <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/evaluation.html#detectron2.evaluation.DatasetEvaluator">DatasetEvaluator</a> for your dataset directly in your main script.</li>
</ul>
<h3 id="6-5-COCO格式的数据集"><a href="#6-5-COCO格式的数据集" class="headerlink" title="6.5 COCO格式的数据集"></a>6.5 COCO格式的数据集</h3><p>如果实例级别数据已经按照COCO的格式保存为一个<code>json</code>文件，那么就能很简单的注册这个数据集</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> register_coco_instances
register_coco_instances<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"json_annotation.json"</span><span class="token punctuation">,</span> <span class="token string">"path/to/image/dir"</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>如果数据已经是COCO格式，但是想要更深入的处理，或有额外自定义的实例标注，可以参考<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/data.html#detectron2.data.datasets.load_coco_json">load_coco_json</a></p>
<h3 id="6-6-更新数据集的配置文件（需要重写）"><a href="#6-6-更新数据集的配置文件（需要重写）" class="headerlink" title="6.6 更新数据集的配置文件（需要重写）"></a>6.6 更新数据集的配置文件（需要重写）</h3><p>当你完成数据集的注册后，可以在<code>cfg.DATASETS.{TRAIN,TEST}</code>中使用你自定义的数据集名称。其他配置文件修改</p>
<ul>
<li><code>MODEL.ROI_HEADS.NUM_CLASSES</code> and <code>MODEL.RETINANET.NUM_CLASSES</code> are the number of thing classes for R-CNN and RetinaNet models, respectively.</li>
<li><code>MODEL.ROI_KEYPOINT_HEAD.NUM_KEYPOINTS</code> sets the number of keypoints for Keypoint R-CNN. You’ll also need to set <a target="_blank" rel="noopener" href="http://cocodataset.org/#keypoints-eval">Keypoint OKS</a> with <code>TEST.KEYPOINT_OKS_SIGMAS</code> for evaluation.</li>
<li><code>MODEL.SEM_SEG_HEAD.NUM_CLASSES</code> sets the number of stuff classes for Semantic FPN &amp; Panoptic FPN.</li>
<li><code>TEST.DETECTIONS_PER_IMAGE</code> controls the maximum number of objects to be detected. Set it to a larger number if test images may contain &gt;100 objects.</li>
<li>If you’re training Fast R-CNN (with precomputed proposals), <code>DATASETS.PROPOSAL_FILES_{TRAIN,TEST}</code> need to match the datasets. The format of proposal files are documented <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/data.html#detectron2.data.load_proposals_into_dataset">here</a>.</li>
</ul>
<h2 id="7-数据加载器"><a href="#7-数据加载器" class="headerlink" title="7. 数据加载器"></a>7. 数据加载器</h2><p>数据加载器负责将数据送入模型。通常一个加载器需要负责从数据集中提取原始数据，并对数据进行预处理，将数据变成模型能够接受的数据。<br>$$<br>Dataloader = 提取数据（硬盘到内存）+数据预处理+传入模型<br>$$</p>
<h3 id="7-1-数据加载器的工作原理"><a href="#7-1-数据加载器的工作原理" class="headerlink" title="7.1 数据加载器的工作原理"></a>7.1 数据加载器的工作原理</h3><ol>
<li><p>首先通过数据集的注册名，加载数据字典<code>list[dict]</code>(轻量级，图像数据还没有加载进入内存)。</p>
</li>
<li><p>对数据字典中的每个元素进行map映射（可以理解为同时对多张图片进行并行化的预处理）</p>
<ul>
<li>用户可以自定义映射函数，默认为<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/data.html#detectron2.data.DatasetMapper">DatasetMapper</a>。</li>
<li>批处理映射得到的结果可以是任意的，只要格式能够被网络接受。</li>
<li>mapper的作用是对图像进行预处理，如果想要对图像进行自定义变换，需要自定义一个mapper</li>
</ul>
</li>
<li><p>mapper是基于批处理的</p>
</li>
<li><p>mapper的结果也是Dataloader的结果，一般也是模型的输入</p>
</li>
</ol>
<h3 id="7-2-自定义数据加载器"><a href="#7-2-自定义数据加载器" class="headerlink" title="7.2 自定义数据加载器"></a>7.2 自定义数据加载器</h3><p>缩放图像</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> detectron2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> T
<span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> DatasetMapper   <span class="token comment" spellcheck="true"># the default mapper</span>
dataloader <span class="token operator">=</span> build_detection_train_loader<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span>
   mapper<span class="token operator">=</span>DatasetMapper<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> augmentations<span class="token operator">=</span><span class="token punctuation">[</span>
      T<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># use this dataloader instead of the default</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>自定义</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> detection_utils <span class="token keyword">as</span> utils
 <span class="token comment" spellcheck="true"># Show how to implement a minimal mapper, similar to the default DatasetMapper</span>
<span class="token keyword">def</span> <span class="token function">mapper</span><span class="token punctuation">(</span>dataset_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dataset_dict <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>dataset_dict<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># it will be modified by code below</span>
    <span class="token comment" spellcheck="true"># can use other ways to read image</span>
    image <span class="token operator">=</span> utils<span class="token punctuation">.</span>read_image<span class="token punctuation">(</span>dataset_dict<span class="token punctuation">[</span><span class="token string">"file_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token operator">=</span><span class="token string">"BGR"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># See "Data Augmentation" tutorial for details usage</span>
    auginput <span class="token operator">=</span> T<span class="token punctuation">.</span>AugInput<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    transform <span class="token operator">=</span> T<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>auginput<span class="token punctuation">)</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>auginput<span class="token punctuation">.</span>image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    annos <span class="token operator">=</span> <span class="token punctuation">[</span>
        utils<span class="token punctuation">.</span>transform_instance_annotations<span class="token punctuation">(</span>annotation<span class="token punctuation">,</span> <span class="token punctuation">[</span>transform<span class="token punctuation">]</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> annotation <span class="token keyword">in</span> dataset_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"annotations"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"># create the format that the model expects</span>
       <span class="token string">"image"</span><span class="token punctuation">:</span> image<span class="token punctuation">,</span>
       <span class="token string">"instances"</span><span class="token punctuation">:</span> utils<span class="token punctuation">.</span>annotations_to_instances<span class="token punctuation">(</span>annos<span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
dataloader <span class="token operator">=</span> build_detection_train_loader<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> mapper<span class="token operator">=</span>mapper<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>   如果想要修改的不仅仅是mapper，那么就需要重写一个dataloader，dataloader本质上是一个python迭代器，无论用什么方式都可以实例化一个。</p>
<h2 id="8-数据增强（未完成）缺少实战理解"><a href="#8-数据增强（未完成）缺少实战理解" class="headerlink" title="8. 数据增强（未完成）缺少实战理解"></a>8. 数据增强（未完成）缺少实战理解</h2><p>数据增强是训练的很重要一部分，<code>Detectron2</code>通过实现以下四个特性（功能）来实现数据增强功能。</p>
<ol>
<li>同时增强所有类型的数据（原图像，目标检测框，掩膜等信息一起变化）</li>
<li>静态数据增强声明（将很多的变化按照顺序排列）</li>
<li>允许增加新的数据类型进行数据增强。（除了1中包含的信息，也允许自定义）</li>
<li>仅通过参数设置进行增强</li>
</ol>
<h3 id="8-1-基础使用"><a href="#8-1-基础使用" class="headerlink" title="8.1 基础使用"></a>8.1 基础使用</h3><p>主要依赖特性1和2</p>
<pre><code>from detectron2.data import transforms as T
# Define a sequence of augmentations:
augs = T.AugmentationList([
    T.RandomBrightness(0.9, 1.1),
    T.RandomFlip(prob=0.5),
    T.RandomCrop("absolute", (640, 640))
])  # type: T.Augmentation

# Define the augmentation input ("image" required, others optional):
input = T.AugInput(image, boxes=boxes, sem_seg=sem_seg)
# Apply the augmentation:
transform = augs(input)  # type: T.Transform
image_transformed = input.image  # new image
sem_seg_transformed = input.sem_seg  # new semantic segmentation

# For any extra data that needs to be augmented together, use transform, e.g.:
image2_transformed = transform.apply_image(image2)
polygons_transformed = transform.apply_polygons(polygons)
</code></pre>
<h3 id="8-2-自定义增强函数"><a href="#8-2-自定义增强函数" class="headerlink" title="8.2 自定义增强函数"></a>8.2 自定义增强函数</h3><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyColorAugmentation</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span>Augmentation<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_transform</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> T<span class="token punctuation">.</span>ColorTransform<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">MyCustomResize</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span>Augmentation<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_transform</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        old_h<span class="token punctuation">,</span> old_w <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        new_h<span class="token punctuation">,</span> new_w <span class="token operator">=</span> int<span class="token punctuation">(</span>old_h <span class="token operator">*</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>old_w <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> T<span class="token punctuation">.</span>ResizeTransform<span class="token punctuation">(</span>old_h<span class="token punctuation">,</span> old_w<span class="token punctuation">,</span> new_h<span class="token punctuation">,</span> new_w<span class="token punctuation">)</span>

augs <span class="token operator">=</span> MyCustomResize<span class="token punctuation">(</span><span class="token punctuation">)</span>
transform <span class="token operator">=</span> augs<span class="token punctuation">(</span>input<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>class MyCustomCrop(T.Augmentation):
    def get_transform(self, image, sem_seg):
        # decide where to crop using both image and sem_seg
        return T.CropTransform(...)

augs = MyCustomCrop()
assert hasattr(input, "image") and hasattr(input, "sem_seg")
transform = augs(input)
</code></pre>
<h3 id="8-3-高级用法"><a href="#8-3-高级用法" class="headerlink" title="8.3 高级用法"></a>8.3 高级用法</h3><h2 id="9-编写模型"><a href="#9-编写模型" class="headerlink" title="9. 编写模型"></a>9. 编写模型</h2><p>很多研究工作都需要从头开始实现功能，但是很多情况下可以借助覆写标准模型的模块来实现。</p>
<h3 id="9-1-注册组件"><a href="#9-1-注册组件" class="headerlink" title="9.1 注册组件"></a>9.1 注册组件</h3><p>完整的网络依据功能常常被分为<code>Backbone</code>，<code>box head</code>等，可以通过<code>Detectron2</code>实现组件的覆写。以添加新的baskbone为例</p>
<p>定义</p>
<pre><code>from detectron2.modeling import BACKBONE_REGISTRY, Backbone, ShapeSpec

@BACKBONE_REGISTRY.register()
class ToyBackbone(Backbone):
  def __init__(self, cfg, input_shape):
    super().__init__()
    # create your own backbone
    self.conv1 = nn.Conv2d(3, 64, kernel_size=7, stride=16, padding=3)

  def forward(self, image):
    return {"conv1": self.conv1(image)}

  def output_shape(self):
    return {"conv1": ShapeSpec(channels=64, stride=16)}
</code></pre>
<p>使用</p>
<pre><code>cfg = ...   # read a config
cfg.MODEL.BACKBONE.NAME = 'ToyBackbone'   # or set it in the config file
model = build_model(cfg)  # it will find `ToyBackbone` defined above
</code></pre>
<h3 id="9-2-显示调用"><a href="#9-2-显示调用" class="headerlink" title="9.2 显示调用"></a>9.2 显示调用</h3><p>通过注册表虽然能实现一些功能，但是想更加细节的，还是需要自己实现。detectron2中的组件都有<code>__init__</code>属性，通过这个属性就能知道接受的参数。</p>
<p>以Faster R-CNN为例，自定义其中box head的损失函数</p>
<ol>
<li><p>损失函数在FastRCNNOutputLayers中计算，需要继承实现这个类，暂时将这个函数命名为<code>myRCNNOutput</code></p>
</li>
<li><p>使用</p>
<pre><code>roi_heads = StandardROIHeads(
  cfg, backbone.output_shape(),
  box_predictor=MyRCNNOutput(...)
)
</code></pre>
</li>
<li><p>如果想要确保新组件从配置文件中而来，那就需要注册</p>
<pre class="line-numbers language-python"><code class="language-python">@ROI_HEADS_REGISTRY<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MyStandardROIHeads</span><span class="token punctuation">(</span>StandardROIHeads<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
    super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span>
                     box_predictor<span class="token operator">=</span>MyRCNNOutput<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h2 id="10-训练"><a href="#10-训练" class="headerlink" title="10. 训练"></a>10. 训练</h2><p>经过上面这些内容的学习，已经能够完成Dataloader和Model的搭建的，接下来就是训练过程了。有两种风格的代码。</p>
<h3 id="10-1-自定义循环训练"><a href="#10-1-自定义循环训练" class="headerlink" title="10.1 自定义循环训练"></a>10.1 自定义循环训练</h3><p>参考<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/tools/plain_train_net.py">tools/plain_train_net.py</a>完全是pytorch风格的，用户有极大的自由。</p>
<h3 id="10-2-抽象训练器"><a href="#10-2-抽象训练器" class="headerlink" title="10.2 抽象训练器"></a>10.2 抽象训练器</h3><p>Detectron2提供了一个标准的训练器，它带有hook系统，能够简化训练过程，主要包含两种实例化。</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.SimpleTrainer">SimpleTrainer</a>为单数据源，单优化器，单数据源的情况提供了一个最小训练循环。如果还想要checkpoint（模型保存与加载），日志记录等，就需要使用hook系统，参考<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.HookBase">hook system</a>.</li>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.defaults.DefaultTrainer">DefaultTrainer</a>是一个由yacs配置初始化的SimpleTrainer，被tools/train_net.py和许多脚本使用。它包含了更多标准的默认行为，包括优化器的默认配置，学习速度计划，日志，评估，检查点等。</li>
</ol>
<p>自定义一个DefaultTrainer。</p>
<ol>
<li><p>For simple customizations (e.g. change optimizer, evaluator, LR scheduler, data loader, etc.), overwrite <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.defaults.DefaultTrainer">its methods</a> in a subclass, just like <a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/tools/train_net.py">tools/train_net.py</a>.</p>
</li>
<li><p>For extra tasks during training, check the <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.HookBase">hook system</a> to see if it’s supported.</p>
<p>As an example, to print hello during training:</p>
<pre><code>class HelloHook(HookBase):
  def after_step(self):
    if self.trainer.iter % 100 == 0:
      print(f"Hello at iteration {self.trainer.iter}!")
</code></pre>
</li>
<li><p>Using a trainer+hook system means there will always be some non-standard behaviors that cannot be supported, especially in research. For this reason, we intentionally keep the trainer &amp; hook system minimal, rather than powerful. If anything cannot be achieved by such a system, it’s easier to start from <a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/tools/plain_train_net.py">tools/plain_train_net.py</a> to implement custom training logic manually.</p>
</li>
</ol>
<h3 id="10-3-日志记录指标"><a href="#10-3-日志记录指标" class="headerlink" title="10.3 日志记录指标"></a>10.3 日志记录指标</h3><p>在训练过程中，评价指标数据被放在集中事件存储 <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/utils.html#detectron2.utils.events.EventStorage">EventStorage</a>中，可以通过以下代码调用 </p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>events <span class="token keyword">import</span> get_event_storage

<span class="token comment" spellcheck="true"># inside the model:</span>
<span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
  value <span class="token operator">=</span> <span class="token comment" spellcheck="true"># compute the value from inputs</span>
  storage <span class="token operator">=</span> get_event_storage<span class="token punctuation">(</span><span class="token punctuation">)</span>
  storage<span class="token punctuation">.</span>put_scalar<span class="token punctuation">(</span><span class="token string">"some_accuracy"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-评价"><a href="#11-评价" class="headerlink" title="11. 评价"></a>11. 评价</h2><p>除了实现常用数据库的评价之外，还可以以输入输出对自定义评价指标，以实例检测为例</p>
<pre><code>class Counter(DatasetEvaluator):
  def reset(self):
    self.count = 0
  def process(self, inputs, outputs):
    for output in outputs:
      self.count += len(output["instances"])
  def evaluate(self):
    # save self.count somewhere, or print it, or return it.
    return {"count": self.count}
</code></pre>
<h3 id="11-1-使用"><a href="#11-1-使用" class="headerlink" title="11.1 使用"></a>11.1 使用</h3><pre><code>def get_all_inputs_outputs():
  for data in data_loader:
    yield data, model(data)

evaluator.reset()
for inputs, outputs in get_all_inputs_outputs():
  evaluator.process(inputs, outputs)
eval_results = evaluator.evaluate()
</code></pre>
<p>也可以将评价指标与数据集绑定</p>
<pre><code>eval_results = inference_on_dataset(
    model,
    data_loader,
    DatasetEvaluators([COCOEvaluator(...), Counter()]))
</code></pre>
<p>与使用模型手动运行评估相比，此函数的好处在于，可以使用DatasetEvaluators将评估器合并在一起，并且所有评估都可以在数据集的一次前向传递中完成。这个函数还为给定的模型和数据集提供精确的速度基准。</p>
<h3 id="11-2-自定义评估器"><a href="#11-2-自定义评估器" class="headerlink" title="11.2 自定义评估器"></a>11.2 自定义评估器</h3><p>detectron2中的许多评估器都是针对特定的数据集，以便使用每个数据集的官方API获得分数。此外，以下两个评估器能够评估任何通用数据集，遵循detectron2的标准数据集格式，所以他们可以用来评估自定义数据集:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/evaluation.html#detectron2.evaluation.COCOEvaluator">COCOEvaluator</a> is able to evaluate AP (Average Precision) for box detection, instance segmentation, keypoint detection on any custom dataset.</li>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/evaluation.html#detectron2.evaluation.SemSegEvaluator">SemSegEvaluator</a> is able to evaluate semantic segmentation metrics on any custom dataset.</li>
</ul>
<h2 id="12-Yacs配置文件"><a href="#12-Yacs配置文件" class="headerlink" title="12. Yacs配置文件"></a>12. Yacs配置文件</h2><p>Detectron2基于键值对的配置文件系统能够用来执行标准行为。系统使用YAML和<a target="_blank" rel="noopener" href="https://github.com/rbgirshick/yacs">yacs</a>。其中Yaml是功能比较有限的一门语言，并不能实现detectron2的所有功能，所以更推荐使用detectron2的API。</p>
<h3 id="12-1-基础使用"><a href="#12-1-基础使用" class="headerlink" title="12.1 基础使用"></a>12.1 基础使用</h3><pre><code>from detectron2.config import get_cfg
cfg = get_cfg()    # obtain detectron2's default config
cfg.xxx = yyy      # add new configs for your own custom components
cfg.merge_from_file("my_cfg.yaml")   # load values from a file

cfg.merge_from_list(["MODEL.WEIGHTS", "weights.pth"])   # can also load values from a list of str
print(cfg.dump())  # print formatted configs
with open("output.yaml", "w") as f:
  f.write(cfg.dump())   # save config to file
</code></pre>
<p>除了基本的Yaml语法外，配置文件还可以定义一个_BASE_: base.yaml。Yaml字段，它将首先加载基本配置文件。如果有任何冲突，基本配置中的值将在子配置中被覆盖。官方为标准模型体系结构提供了几个基本配置。detectron2中的许多内置工具接受命令行配置覆盖:命令行中提供的键值对将覆盖配置文件中的现有值。例如，<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/demo/demo.py">demo.py</a>可以用于</p>
<pre><code>./demo.py --config-file config.yaml [--other-options] \
  --opts MODEL.WEIGHTS /path/to/weights INPUT.MIN_SIZE_TEST 1000
</code></pre>
<h3 id="12-2-在项目中配置"><a href="#12-2-在项目中配置" class="headerlink" title="12.2 在项目中配置"></a>12.2 在项目中配置</h3><p>在detectron2库之外的项目可以定义自己的configs，需要添加这些configs才能使项目发挥作用，例如:</p>
<pre><code>from detectron2.projects.point_rend import add_pointrend_config
cfg = get_cfg()    # obtain detectron2's default config
add_pointrend_config(cfg)  # add pointrend's default config
# ... ...
</code></pre>
<h3 id="12-3-最佳实践"><a href="#12-3-最佳实践" class="headerlink" title="12.3 最佳实践"></a>12.3 最佳实践</h3><ol>
<li>把你写的配置当作“代码”:避免复制它们;使用_BASE_在配置之间共享公共部分。</li>
<li>保持编写的配置简单:不要包含不会影响实验设置的键。</li>
</ol>
<h2 id="13-Lazy-配置"><a href="#13-Lazy-配置" class="headerlink" title="13. Lazy 配置"></a>13. Lazy 配置</h2><p>传统的基于yacs的配置系统提供基本的、标准的功能。然而，它不能为许多新项目提供足够的灵活性。Detectron2开发了一个可选的、非侵入性的配置系统，可用于detectron2或任何其他复杂项目。</p>
<h3 id="13-1-python语法"><a href="#13-1-python语法" class="headerlink" title="13.1 python语法"></a>13.1 python语法</h3><p>基于python的字典而不是Yaml，有以下几点好处</p>
<ol>
<li>借助python更好的操作字典。（增删）</li>
<li>编写简单的结构与共能</li>
<li>使用更多的数据类型与结构</li>
<li>使用Python导入语法导入/组合其他配置文件。</li>
</ol>
<p>使用</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># config.py:</span>
a <span class="token operator">=</span> dict<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> z<span class="token operator">=</span>dict<span class="token punctuation">(</span>xx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> dict<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># my_code.py:</span>
<span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>config <span class="token keyword">import</span> LazyConfig
cfg <span class="token operator">=</span> LazyConfig<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"path/to/config.py"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># an omegaconf dictionary</span>
<span class="token keyword">assert</span> cfg<span class="token punctuation">.</span>a<span class="token punctuation">.</span>z<span class="token punctuation">.</span>xx <span class="token operator">==</span> <span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyConfig.load">LazyConfig.load</a>后，cfg就成为一个包含定义在全局上的所有字典信息的字典。需要注意的是</p>
<ul>
<li>All dictionaries are turned to an <a target="_blank" rel="noopener" href="https://omegaconf.readthedocs.io/">omegaconf</a> config object during loading. This enables access to omegaconf features, such as its <a target="_blank" rel="noopener" href="https://omegaconf.readthedocs.io/en/2.1_branch/usage.html#access-and-manipulation">access syntax</a> and <a target="_blank" rel="noopener" href="https://omegaconf.readthedocs.io/en/2.1_branch/usage.html#variable-interpolation">interpolation</a>.</li>
<li>Absolute imports in <code>config.py</code> works the same as in regular Python.</li>
<li>Relative imports can only import dictionaries from config files. They are simply a syntax sugar for <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyConfig.load_rel">LazyConfig.load_rel</a>. They can load Python files at relative path without requiring <code>__init__.py</code>.</li>
</ul>
<p>（绝对/相对引入是什么？）</p>
<p><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyConfig.save">LazyConfig.save</a>可以将配置对象保存到yaml。注意，，这并不总是最有效的，如果配置文件中出现了不可序列化的对象(例如lambdas)。用户自行决定是否牺牲节省的能力来换取灵活性。</p>
<h3 id="13-2-递归的实例化"><a href="#13-2-递归的实例化" class="headerlink" title="13.2 递归的实例化"></a>13.2 递归的实例化</h3><p>We provide a helper function <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyCall">LazyCall</a> that helps create such dictionaries. The following code using <code>LazyCall</code></p>
<pre><code>from detectron2.config import LazyCall as L
from my_app import Trainer, Optimizer
cfg = L(Trainer)(
  optimizer=L(Optimizer)(
    lr=0.01,
    algo="SGD"
  )
)
</code></pre>
<p>creates a dictionary like this:</p>
<pre><code>cfg = {
  "_target_": "my_app.Trainer",
  "optimizer": {
    "_target_": "my_app.Optimizer",
    "lr": 0.01, "algo": "SGD"
  }
}
</code></pre>
<p>By representing objects using such dictionaries, a general <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.instantiate">instantiate</a> function can turn them into actual objects, i.e.:</p>
<pre><code>from detectron2.config import instantiate
trainer = instantiate(cfg)
# equivalent to:
# from my_app import Trainer, Optimizer
# trainer = Trainer(optimizer=Optimizer(lr=0.01, algo="SGD"))
</code></pre>
<p>This pattern is powerful enough to describe very complex objects, e.g.:</p>
<p>A Full Mask R-CNN described in recursive instantiation</p>
<pre><code>from detectron2.config import LazyCall as L
from detectron2.layers import ShapeSpec
from detectron2.modeling.meta_arch import GeneralizedRCNN
from detectron2.modeling.anchor_generator import DefaultAnchorGenerator
from detectron2.modeling.backbone.fpn import LastLevelMaxPool
from detectron2.modeling.backbone import BasicStem, FPN, ResNet
from detectron2.modeling.box_regression import Box2BoxTransform
from detectron2.modeling.matcher import Matcher
from detectron2.modeling.poolers import ROIPooler
from detectron2.modeling.proposal_generator import RPN, StandardRPNHead
from detectron2.modeling.roi_heads import (
    StandardROIHeads,
    FastRCNNOutputLayers,
    MaskRCNNConvUpsampleHead,
    FastRCNNConvFCHead,
)

model = L(GeneralizedRCNN)(
    backbone=L(FPN)(
        bottom_up=L(ResNet)(
            stem=L(BasicStem)(in_channels=3, out_channels=64, norm="FrozenBN"),
            stages=L(ResNet.make_default_stages)(
                depth=50,
                stride_in_1x1=True,
                norm="FrozenBN",
            ),
            out_features=["res2", "res3", "res4", "res5"],
        ),
        in_features="${.bottom_up.out_features}",
        out_channels=256,
        top_block=L(LastLevelMaxPool)(),
    ),
    proposal_generator=L(RPN)(
        in_features=["p2", "p3", "p4", "p5", "p6"],
        head=L(StandardRPNHead)(in_channels=256, num_anchors=3),
        anchor_generator=L(DefaultAnchorGenerator)(
            sizes=[[32], [64], [128], [256], [512]],
            aspect_ratios=[0.5, 1.0, 2.0],
            strides=[4, 8, 16, 32, 64],
            offset=0.0,
        ),
        anchor_matcher=L(Matcher)(
            thresholds=[0.3, 0.7], labels=[0, -1, 1], allow_low_quality_matches=True
        ),
        box2box_transform=L(Box2BoxTransform)(weights=[1.0, 1.0, 1.0, 1.0]),
        batch_size_per_image=256,
        positive_fraction=0.5,
        pre_nms_topk=(2000, 1000),
        post_nms_topk=(1000, 1000),
        nms_thresh=0.7,
    ),
    roi_heads=L(StandardROIHeads)(
        num_classes=80,
        batch_size_per_image=512,
        positive_fraction=0.25,
        proposal_matcher=L(Matcher)(
            thresholds=[0.5], labels=[0, 1], allow_low_quality_matches=False
        ),
        box_in_features=["p2", "p3", "p4", "p5"],
        box_pooler=L(ROIPooler)(
            output_size=7,
            scales=(1.0 / 4, 1.0 / 8, 1.0 / 16, 1.0 / 32),
            sampling_ratio=0,
            pooler_type="ROIAlignV2",
        ),
        box_head=L(FastRCNNConvFCHead)(
            input_shape=ShapeSpec(channels=256, height=7, width=7),
            conv_dims=[],
            fc_dims=[1024, 1024],
        ),
        box_predictor=L(FastRCNNOutputLayers)(
            input_shape=ShapeSpec(channels=1024),
            test_score_thresh=0.05,
            box2box_transform=L(Box2BoxTransform)(weights=(10, 10, 5, 5)),
            num_classes="${..num_classes}",
        ),
        mask_in_features=["p2", "p3", "p4", "p5"],
        mask_pooler=L(ROIPooler)(
            output_size=14,
            scales=(1.0 / 4, 1.0 / 8, 1.0 / 16, 1.0 / 32),
            sampling_ratio=0,
            pooler_type="ROIAlignV2",
        ),
        mask_head=L(MaskRCNNConvUpsampleHead)(
            input_shape=ShapeSpec(channels=256, width=14, height=14),
            num_classes="${..num_classes}",
            conv_dims=[256, 256, 256, 256, 256],
        ),
    ),
    pixel_mean=[103.530, 116.280, 123.675],
    pixel_std=[1.0, 1.0, 1.0],
    input_format="BGR",
)
</code></pre>
<p>There are also objects or logic that cannot be described simply by a dictionary, such as reused objects or method calls. They may require some refactoring to work with recursive instantiation.</p>
<h3 id="13-3-使用Model-Zoo-LazyConfigs"><a href="#13-3-使用Model-Zoo-LazyConfigs" class="headerlink" title="13.3 使用Model Zoo LazyConfigs"></a>13.3 使用Model Zoo LazyConfigs</h3><h3 id="13-4-总结"><a href="#13-4-总结" class="headerlink" title="13.4 总结"></a>13.4 总结</h3><h2 id="14-部署"><a href="#14-部署" class="headerlink" title="14. 部署"></a>14. 部署</h2><p>用Python编写的模型需要经过导出过程才能成为可部署的构件。关于这个过程的一些基本概念:</p>
<p>“导出方法”是将Python模型完全序列化为可部署格式的方式。Detectron2支持以下导出方式:</p>
<ul>
<li><code>tracing</code>: see <a target="_blank" rel="noopener" href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html">pytorch documentation</a> to learn about it</li>
<li><code>scripting</code>: see <a target="_blank" rel="noopener" href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html">pytorch documentation</a> to learn about it</li>
<li><code>caffe2_tracing</code>: replace parts of the model by caffe2 operators, then use tracing.(将要被舍弃，不建议使用)</li>
</ul>
<table>
<thead>
<tr>
<th>Export Method</th>
<th>tracing</th>
<th>scripting</th>
<th>caffe2_tracing</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Formats</strong></td>
<td>TorchScript</td>
<td>TorchScript</td>
<td>Caffe2, TorchScript, ONNX</td>
</tr>
<tr>
<td><strong>Runtime</strong></td>
<td>PyTorch</td>
<td>PyTorch</td>
<td>Caffe2, PyTorch</td>
</tr>
<tr>
<td>C++/Python inference</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Dynamic resolution</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>Batch size requirement</td>
<td>Constant</td>
<td>Dynamic</td>
<td>Batch inference unsupported</td>
</tr>
<tr>
<td>Extra runtime deps</td>
<td>torchvision</td>
<td>torchvision</td>
<td>Caffe2 ops (usually alreadyincluded in PyTorch)</td>
</tr>
<tr>
<td>Faster/Mask/Keypoint R-CNN</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>RetinaNet</td>
<td>✅</td>
<td>✅</td>
<td>✅</td>
</tr>
<tr>
<td>PointRend R-CNN</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
<tr>
<td>Cascade R-CNN</td>
<td>✅</td>
<td>❌</td>
<td>❌</td>
</tr>
</tbody></table>
<p><strong>“Format”</strong> is how a serialized model is described in a file, e.g. TorchScript, Caffe2 protobuf, ONNX format. <strong>“Runtime”</strong> is an engine that loads a serialized model and executes it, e.g., PyTorch, Caffe2, TensorFlow, onnxruntime, TensorRT, etc. A runtime is often tied to a specific format (e.g. PyTorch needs TorchScript format, Caffe2 needs protobuf format). We currently support the following combination and each has some limitations:</p>
<p><code>caffe2_tracing</code> is going to be deprecated. We don’t plan to work on additional support for other formats/runtime, but contributions are welcome.</p>
<h3 id="14-1-使用Tracing或Scripting进行部署"><a href="#14-1-使用Tracing或Scripting进行部署" class="headerlink" title="14.1 使用Tracing或Scripting进行部署"></a>14.1 使用Tracing或Scripting进行部署</h3><p>模型可以通过Tracing或Scripting导出为TorchScript格式。在Python或c++中，输出模型文件可以在不依赖于detectron2的情况下加载。导出的模型通常需要对一些自定义操作的torchvision(或其c++库)依赖。</p>
<p>该功能要求PyTorch≥1.8。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">W TJ</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2021/12/30/detectron2/">http://example.com/2021/12/30/detectron2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">W TJ</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
                                    <span class="chip bg-color">深度学习</span>
                                </a>
                            
                                <a href="/tags/Detectron2/">
                                    <span class="chip bg-color">Detectron2</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/12/30/bo-ke-ji-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="博客计划">
                        
                        <span class="card-title">博客计划</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-12-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            W TJ
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%A1%E5%88%92/">
                        <span class="chip bg-color">计划</span>
                    </a>
                    
                    <a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">
                        <span class="chip bg-color">博客搭建</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/12/27/dockerh-gua-zai-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Dockerh挂载总结">
                        
                        <span class="card-title">Dockerh挂载总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-12-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            W TJ
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Docker/">
                        <span class="chip bg-color">Docker</span>
                    </a>
                    
                    <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%B7%A5%E5%85%B7/">
                        <span class="chip bg-color">计算机工具</span>
                    </a>
                    
                    <a href="/tags/%E8%BD%AC%E8%BD%BD/">
                        <span class="chip bg-color">转载</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <a href="/about" target="_blank">W TJ</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wangxiatian" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:961717731@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=961717731" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 961717731" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
