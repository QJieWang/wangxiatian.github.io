<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Detectron2, WTJ">
    <meta name="description" content="Detectron20. æœ¬æ–‡çš„åŸºæœ¬ä¿¡æ¯æœ¬æ–‡å†™äº2021å¹´12æœˆ27æ—¥ã€‚12ç« å¾€åçš„å†…å®¹éœ€è¦è‡ªå·±åœ¨å®æˆ˜ä¸­ç»“åˆè‡ªå·±çš„ç†è§£é‡æ–°ç¼–å†™ï¼Œæ‰€ä»¥ä¼šç»§ç»­ä¿®æ”¹ã€‚Detectron2å°†åˆ†ä¸ºä¸¤ä¸ªæ–‡ç« ï¼Œä¸€ä¸ªæ˜¯æœ¬æ–‡åŸºäºconfigå¦ä¸€ä¸ªæ˜¯cloabå½¢å¼åŸºäºAPIçš„">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Detectron2 | WTJ</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 5.4.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="WTJ" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">WTJ</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>é¦–é¡µ</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>æ ‡ç­¾</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>åˆ†ç±»</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>å½’æ¡£</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>å…³äº</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>ç•™è¨€æ¿</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>å‹æƒ…é“¾æ¥</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="æœç´¢" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">WTJ</div>
        <div class="logo-desc">
            
            ä¸ªäººçš„ç¬”è®°
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			é¦–é¡µ
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			æ ‡ç­¾
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			åˆ†ç±»
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			å½’æ¡£
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			å…³äº
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			ç•™è¨€æ¿
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			å‹æƒ…é“¾æ¥
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('è®¿é—®å¯†ç ')).toString(CryptoJS.enc.Hex)) {
                alert('å¯†ç é”™è¯¯ï¼Œå°†è¿”å›ä¸»é¡µï¼');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Detectron2</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- æ–‡ç« å†…å®¹è¯¦æƒ… -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
                                <span class="chip bg-color">æ·±åº¦å­¦ä¹ </span>
                            </a>
                        
                            <a href="/tags/Detectron2/">
                                <span class="chip bg-color">Detectron2</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>å‘å¸ƒæ—¥æœŸ:&nbsp;&nbsp;
                    2021-12-30
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Detectron2"><a href="#Detectron2" class="headerlink" title="Detectron2"></a>Detectron2</h1><h2 id="0-æœ¬æ–‡çš„åŸºæœ¬ä¿¡æ¯"><a href="#0-æœ¬æ–‡çš„åŸºæœ¬ä¿¡æ¯" class="headerlink" title="0. æœ¬æ–‡çš„åŸºæœ¬ä¿¡æ¯"></a>0. æœ¬æ–‡çš„åŸºæœ¬ä¿¡æ¯</h2><p>æœ¬æ–‡å†™äº2021å¹´12æœˆ27æ—¥ã€‚12ç« å¾€åçš„å†…å®¹éœ€è¦è‡ªå·±åœ¨å®æˆ˜ä¸­ç»“åˆè‡ªå·±çš„ç†è§£é‡æ–°ç¼–å†™ï¼Œæ‰€ä»¥ä¼šç»§ç»­ä¿®æ”¹ã€‚Detectron2å°†åˆ†ä¸ºä¸¤ä¸ªæ–‡ç« ï¼Œä¸€ä¸ªæ˜¯æœ¬æ–‡åŸºäºconfigå¦ä¸€ä¸ªæ˜¯cloabå½¢å¼åŸºäºAPIçš„ã€‚</p>
<p>å®˜ç½‘å¾ˆé‡è¦ï¼Œå¸¸çœ‹å®˜ç½‘ã€‚</p>
<h2 id="1-ä»‹ç»"><a href="#1-ä»‹ç»" class="headerlink" title="1. ä»‹ç»"></a>1. ä»‹ç»</h2><p>Detectron2 æ˜¯Facebook AI Researchæä¾›çš„ä¸€æ¬¾ç®—æ³•åº“ï¼ŒåŒ…å«ç›®æ ‡æ£€æµ‹å’Œåˆ†å‰²ã€‚å®Œå…¨ç”±PyTorchç¼–å†™ï¼Œå¯ä»¥ç”¨æ¥å­¦ä¹ ä¸å¿«é€Ÿéƒ¨ç½²ã€‚</p>
<div align="center">
  <img src="https://user-images.githubusercontent.com/1381301/66535560-d3422200-eace-11e9-9123-5535d469db19.png">
</div>

<p>å‡ ä¸ªå…³é”®çš„é“¾æ¥</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2">å®˜æ–¹Githubé“¾æ¥</a></li>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/getting_started.html">å®˜æ–¹æ•™ç¨‹</a></li>
</ul>
<h2 id="2-ä½¿ç”¨æ•™ç¨‹"><a href="#2-ä½¿ç”¨æ•™ç¨‹" class="headerlink" title="2. ä½¿ç”¨æ•™ç¨‹"></a>2. ä½¿ç”¨æ•™ç¨‹</h2><h3 id="2-1-åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šå®‰è£…"><a href="#2-1-åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šå®‰è£…" class="headerlink" title="2.1.  åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šå®‰è£…"></a>2.1.  åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šå®‰è£…</h3><h4 id="1-é™åˆ¶"><a href="#1-é™åˆ¶" class="headerlink" title="1. é™åˆ¶"></a>1. é™åˆ¶</h4><ul>
<li><code>Detectron2</code>åªèƒ½åœ¨Linuxå’ŒMacOSä¸Šè¿è¡Œ</li>
<li><code>python</code>ç‰ˆæœ¬  â‰¥ 3.6</li>
<li><code>PyTorch</code>ç‰ˆæœ¬  â‰¥ 3.6ï¼Œ<code>toechvision</code>éœ€è¦ä¸PyTorchç‰ˆæœ¬ä¸€è‡´ï¼ˆæ­£å¸¸éƒ½æ˜¯ä¸€èµ·è£…çš„ï¼‰</li>
<li>å»ºè®®å®‰è£…<code>OpenCV</code>ï¼Œå¾ˆå¤šæ ·ä¾‹æ•™ç¨‹ä¸å¯è§†åŒ–éƒ½ä¾èµ–å®ƒ</li>
</ul>
<h4 id="2-å®‰è£…"><a href="#2-å®‰è£…" class="headerlink" title="2. å®‰è£…"></a>2. å®‰è£…</h4><p>æä¾›ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œä½†æ˜¯åªæœ‰Linuxæœ‰å¯¹åº”ç›´æ¥å¯ç”¨çš„é¢„ç¼–è¯‘æ–‡ä»¶ï¼ŒåŒæ—¶æ¯éš”å‡ ä¸ªæœˆ<code>Detectron2</code>å°±æœ‰æ–°ç‰ˆæœ¬ï¼Œè®°å¾—æ›´æ–°ã€‚</p>
<ul>
<li><p>è‡ªå·±ç¼–è¯‘ï¼ˆgcc &amp; g++ â‰¥ 5.4ï¼ŒåŒæ—¶æ¨èå®‰è£…ninjaå¯ä»¥åŠ é€Ÿç¼–è¯‘ï¼‰</p>
<ul>
<li><pre class="line-numbers language-shell"><code class="language-shell">python -m pip install 'git+https://github.com/facebookresearch/detectron2.git'
# (add --user if you don't have permission)

# Or, to install it from a local clone:
git clone https://github.com/facebookresearch/detectron2.git
python -m pip install -e detectron2

# On macOS, you may need to prepend the above commands with a few environment variables:
CC=clang CXX=clang++ ARCHFLAGS="-arch x86_64" python -m pip install ...
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>æ¯æ¬¡é‡æ–°å®‰è£…PyTorchåéƒ½éœ€è¦é‡æ–°ç¼–è¯‘æ‰å¯ç”¨</p>
</li>
</ul>
</li>
<li><p>å®˜æ–¹é¢„ç¼–è¯‘æ–‡ä»¶ï¼ˆåªæœ‰Linuxæœ‰ï¼‰</p>
<ul>
<li><p>éœ€è¦çœ‹å¥½å¯¹åº”çš„<code>Torch</code>å’Œ<code>CUDA</code>ç‰ˆæœ¬é€‰æ‹©å®‰è£…ï¼Œå¦‚æœä¸¤è€…ç»„åˆä¸åœ¨å®˜æ–¹åˆ—è¡¨ä¹‹å†…ï¼ˆå®˜æ–¹æ•™ç¨‹ä¸­æŸ¥çœ‹ï¼‰ï¼Œå°±éœ€è¦è‡ªå·±ç¼–è¯‘ã€‚</p>
</li>
<li><p>é¦–å…ˆæŸ¥çœ‹è‡ªå·±çš„pythonç‰ˆæœ¬</p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> torch
<span class="token keyword">print</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>__version__<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># '1.9.0+cu111' æ°å¥½åœ¨å®˜æ–¹çš„æ”¯æŒä¹‹åˆ—</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>è¿™é‡Œä»¥<code>CUDA</code>11.1ï¼Œ<code>torch</code>1.9ä¸ºä¾‹</p>
</li>
<li><pre class="line-numbers language-shell"><code class="language-shell">python -m pip install detectron2 -f https://dl.fbaipublicfiles.com/detectron2/wheels/cu111/torch1.9/index.html
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="2-2-åœ¨Colabä¸Dockerä½¿ç”¨"><a href="#2-2-åœ¨Colabä¸Dockerä½¿ç”¨" class="headerlink" title="2.2 åœ¨Colabä¸Dockerä½¿ç”¨"></a>2.2 åœ¨Colabä¸Dockerä½¿ç”¨</h3><p>Colabä½¿ç”¨</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5">Detectron2 Tutorial.ipynb - Colaboratory (google.com)</a></li>
</ul>
<p>Dockerä½¿ç”¨</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/tree/main/docker">detectron2/docker at main Â· facebookresearch/detectron2 (github.com)</a></li>
</ul>
<p>ä¸¤ç§æ–¹å¼éƒ½èƒ½é¿å…åœ¨è‡ªå·±ç”µè„‘ä¸Šå®‰è£…æ—¶å‡ºç°çš„å¾ˆå¤šé—®é¢˜ï¼Œå³ä½¿åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šä¹Ÿæ¨èä½¿ç”¨Dockerã€‚</p>
<p>æˆ‘è‡ªå·±Dockerç”¨çš„æ¯”è¾ƒå¤šæ‰€ä»¥å°±è¯¦ç»†ä»‹ç»ä¸€ä¸‹Dockerçš„å®‰è£…ä¸ä½¿ç”¨ï¼Œä¸€äº›ç¼ºç‚¹ï¼šä¹‹å‰å®‰è£…è¿‡Dockerä¸CUDAçš„ä¾èµ–ï¼Œæ‰€ä»¥è¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œå¦‚æœå‡ºç°ä¸èƒ½ä½¿ç”¨CUDAçš„æƒ…å†µï¼Œè¿˜æ˜¯è¦è‡ªè¡Œç™¾åº¦çš„ã€‚</p>
<ul>
<li><ol>
<li><p>å…‹éš†å®˜æ–¹ä»“åº“</p>
<pre class="line-numbers language-shell"><code class="language-shell">git clone https://github.com/facebookresearch/detectron2.git
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>è¿›å…¥<code>Detectron2</code>ä¸‹çš„Dockerç›®å½•</p>
<pre class="line-numbers language-shell"><code class="language-shell">cd docker
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>ç¼–è¯‘<code>Docker</code></p>
<pre class="line-numbers language-shell"><code class="language-shell"># Dockeræ˜¯ä¸€å±‚ä¸€å±‚çš„ä¸‹è½½ï¼Œé€Ÿåº¦çœ‹ä¸ªäººï¼Œå¦‚æœå¾ˆæ…¢å¯ä»¥ç™¾åº¦æ·»åŠ é˜¿é‡Œdockeræº
docker build --build-arg USER_ID=$UID -t detectron2:v0 .
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>å¯åŠ¨<code>Docker</code>å¹¶æŒ‚è½½æ–‡ä»¶å¤¹</p>
<pre class="line-numbers language-shell"><code class="language-shell">docker run --gpus all -it --shm-size=8gb --env="DISPLAY" --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" --name=detectron2 detectron2:v0
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>å¼€å¯å›¾åƒæ˜¾ç¤º</p>
<pre class="line-numbers language-shell"><code class="language-shell">xhost +local:`docker inspect --format='{{ .Config.Hostname }}' detectron2`
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>ä¸ªäººçš„ä¸€äº›å»ºè®®</p>
<p>æ¨èvscodeè¿œç¨‹è¿æ¥<code>docker</code>é•œåƒï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦ï¼Œå®ç°è¿œç¨‹å¼€å‘ã€‚</p>
<ol>
<li>å®‰è£…æ’ä»¶<code>Remote Development</code>ï¼Œä¼šè‡ªåŠ¨å®‰è£…ä¸‰ä¸ªæ’ä»¶,è¯¦ç»†çœ‹æ’ä»¶ä»‹ç»ã€‚</li>
<li>vscodeè¿æ¥è¿œç¨‹ç”µè„‘ï¼ˆå¦‚æœDockeråœ¨æœ¬æœºä¸Šå°±ä¸éœ€è¦äº†ï¼‰ï¼Œä¸€å®šè¦é…ç½®SSHå…å¯†ç™»å½•ï¼Œä¸ç„¶æ–­è¿çš„ä½“éªŒä¼šå¾ˆç³Ÿç³•ã€‚</li>
<li>vscodeè¿æ¥è¿œç¨‹ç”µè„‘é‡Œçš„Docker</li>
</ol>
</li>
</ol>
</li>
</ul>
<h2 id="3-å¼€å§‹é£Ÿç”¨-smirk"><a href="#3-å¼€å§‹é£Ÿç”¨-smirk" class="headerlink" title="3. å¼€å§‹é£Ÿç”¨ :smirk:"></a>3. å¼€å§‹é£Ÿç”¨ <span class="github-emoji"><span>ğŸ˜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f60f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></h2><h3 id="1-Demo"><a href="#1-Demo" class="headerlink" title="1.Demo"></a>1.Demo</h3><p>ä»¥<code>Detectron2</code>é¡¹ç›®æ–‡ä»¶å¤¹ä¸ºæ ¹ç›®å½•,å¯ä»¥é€‰æ‹©çš„æ¨¡å‹åœ¨<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/MODEL_ZOO.md">detectron2/MODEL_ZOO.md</a>ç›®å½•ä¸‹æœ‰è¯¦ç»†çš„ä»‹ç»ï¼Œè¿™é‡Œåªè¿è¡Œå®˜æ–¹çš„demo</p>
<pre class="line-numbers language-shell"><code class="language-shell">cd demo/
python demo.py --config-file ../configs/COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml --input input1.jpg input2.jpg [--other-options] --opts MODEL.WEIGHTS detectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl
# è¿è¡Œçš„ä¼šæ¯”è¾ƒæ…¢ï¼Œéœ€è¦ä¸‹è½½å®˜æ–¹ä¸è®­ç»ƒæƒé‡
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="2-å‘½ä»¤è¡Œè®­ç»ƒä¸è¯„ä¼°"><a href="#2-å‘½ä»¤è¡Œè®­ç»ƒä¸è¯„ä¼°" class="headerlink" title="2. å‘½ä»¤è¡Œè®­ç»ƒä¸è¯„ä¼°"></a>2. å‘½ä»¤è¡Œè®­ç»ƒä¸è¯„ä¼°</h3><p>åœ¨toolç›®å½•ä¸‹æœ‰ä¸¤ä¸ªå‡½æ•°æ–‡ä»¶<code>plain_train_net.py</code>å’Œ<code>train_net.py</code>ã€‚è¿™ä¸¤ä¸ªå‡½æ•°èƒ½è®­ç»ƒ<code>Detectron2</code>ä¸­çš„æ‰€æœ‰é…ç½®ç½‘ç»œã€‚è¿™ä¸¤ä¸ªå‡½æ•°æ–‡ä»¶å¯ä»¥ä½œä¸ºå‚è€ƒï¼Œç¼–å†™ç”¨æˆ·è‡ªå·±çš„è®­ç»ƒè„šæœ¬ã€‚<br><code>plain_train_net.py</code>å’Œ<code>train_net.py</code>çš„åŒºåˆ«ï¼š<code>plain_train_net.py</code>æ”¯æŒæ›´å°‘çš„ç‰¹æ€§ï¼Œæ›´å°‘çš„æŠ½è±¡ç±»ï¼Œæ‰€ä»¥ä¿®æ”¹èµ·æ¥æ›´å®¹æ˜“ã€‚</p>
<p>æƒ³è¦è¯„ä¼°ç½‘ç»œæ•ˆæœåªéœ€è¦æ·»åŠ <code>--eval-only</code>,æ›´å¤šçš„å‚æ•°é€‰æ‹©å¯ä»¥æŸ¥çœ‹å‡½æ•°æ–‡ä»¶æˆ–è€…ä½¿ç”¨<code>./train_net.py -h</code></p>
<h3 id="3-å‡½æ•°APIä½¿ç”¨"><a href="#3-å‡½æ•°APIä½¿ç”¨" class="headerlink" title="3. å‡½æ•°APIä½¿ç”¨"></a>3. å‡½æ•°APIä½¿ç”¨</h3><ol>
<li>å‚è€ƒå®˜æ–¹çš„Colab<a target="_blank" rel="noopener" href="https://colab.research.google.com/drive/16jcaJoc6bCFAQ96jDe2HwtXj7BMD_-m5">Detectron2 Tutorial.ipynb - Colaboratory (google.com)</a></li>
<li>æ›´å¤šåŸºäºdetectron2çš„é¡¹ç›®å‚è€ƒ<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/tree/main/projects">detectron2/projects at main Â· facebookresearch/detectron2 (github.com)</a>ï¼ˆä½†æ˜¯è¿™äº›é¡¹ç›®çš„ä¸€äº›ç‰¹æ€§ä¸ç¨³å®šæ€§ä¸ä¸€å®šæœ‰Detectron2é‚£ä¹ˆé«˜ï¼‰</li>
</ol>
<h2 id="4-æ„å»ºå†…ç½®æ•°æ®é›†"><a href="#4-æ„å»ºå†…ç½®æ•°æ®é›†" class="headerlink" title="4. æ„å»ºå†…ç½®æ•°æ®é›†"></a>4. æ„å»ºå†…ç½®æ•°æ®é›†</h2><p>å¯ä»¥é€šè¿‡<code>DasetCatalong</code>æˆ–è€…<code>MetadataCatalog</code>è®¿é—®æ•°æ®ï¼Œè¯¦ç»†å‚è€ƒ<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/datasets.html">Custom Datasets</a>ã€‚åŒæ—¶<code>Detectron2</code>ä¹Ÿå†…ç½®äº†ä¸€äº›æ•°æ®é›†,åŒ…æ‹¬</p>
<ul>
<li>COCO</li>
<li>lvis</li>
<li>cityscapes</li>
<li>VOC20{07,12}</li>
</ul>
<p>å¯ä»¥é€šè¿‡å‘½ä»¤ï¼ŒæŒ‡å®šå†…ç½®æ•°æ®é›†çš„åœ°å€</p>
<pre class="line-numbers language-shell"><code class="language-shell"># /path/to/datasetsé»˜è®¤ä¸º./datasets
export DETECTRON2_DATASETS=/path/to/datasets
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="5-æ‹“å±•Detectron2çš„åŠŸèƒ½"><a href="#5-æ‹“å±•Detectron2çš„åŠŸèƒ½" class="headerlink" title="5. æ‹“å±•Detectron2çš„åŠŸèƒ½"></a>5. æ‹“å±•<code>Detectron2</code>çš„åŠŸèƒ½</h2><p>æ·±åº¦å­¦ä¹ çš„ç ”ç©¶æ„å‘³ç€åšæ–°çš„å·¥ä½œï¼Œä½†æ˜¯è¿™å°±å¸¦æ¥ä¸€ä¸ªæ–°çš„æŒ‘æˆ˜ï¼Œå¦‚ä½•åœ¨ä»£ç æŠ½è±¡ä¸å…·ä½“å®ç°ä¸­å¹³è¡¡ã€‚å¦‚æœæŠ½è±¡å±‚æ¬¡å¾ˆé«˜ï¼Œé‚£ä¹ˆä½¿ç”¨è€…å°±èƒ½åˆ©ç”¨æ¡†æ¶ç®€å•çš„åšå¾ˆå¤šçš„äº‹ï¼Œä½†æ˜¯è¿™ä¹Ÿæ„å‘³ç€å¾ˆéš¾å®ç°ç ”ç©¶è€…çš„åˆ›æ„ä¸çªç ´æ¡†æ¶ã€‚å°±åƒæ˜¯æ‰«å¸šå’Œå¸å°˜å™¨ï¼Œè™½ç„¶å¸å°˜å™¨å¾ˆå¥½ç”¨ï¼Œè§£æ”¾äº†äººåŠ›ï¼Œä½†æ˜¯æƒ³ç”¨å¸å°˜å™¨èµ¶è€é¼ æ˜¯ä¸å¯èƒ½çš„ï¼ˆåšä¸€äº›åˆ›æ–°ï¼‰ï¼Œè¿˜æ˜¯æ‰«å¸šæ›´å¥½ç”¨ã€‚</p>
<p>åœ¨<code>Detectron2</code>ä¸­ï¼Œé€šè¿‡æä¾›ä¸¤ç§æ¥å£æ¥å¹³è¡¡ï¼Œåˆ†åˆ«æ˜¯<strong>é…ç½®æ¥å£</strong>ä¸<strong>å…·ä½“å‚æ•°</strong></p>
<ul>
<li><p>é…ç½®æ¥å£ï¼ˆconfig argumentï¼‰ </p>
<ul>
<li><p>å¤§å®¶åªéœ€è¦åœ¨ä¸“å®¶åˆ›å»ºçš„<code>yml</code>æ–‡ä»¶çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå°±èƒ½å®ç°è‡ªå·±æƒ³è¦çš„æ•ˆæœï¼Œå¾ˆå¤šå‚æ•°éƒ½æœ‰é»˜è®¤å€¼ï¼Œä¸äº†è§£éƒ½ä¸ä¼šæœ‰å½±å“ï¼Œåªéœ€è¦è®°å¾—å¸¸ç”¨çš„ã€‚è¯¦ç»†å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/configs.html">Yacs Configs</a>ã€‚</p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># load proper yaml config file, then</span>
model <span class="token operator">=</span> build_model<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>å…·ä½“å‚æ•°ï¼ˆexplicit argumentsï¼‰</p>
<ul>
<li><p>æ¯ä¸€ä¸ªå‡½æ•°éƒ½æ˜¯æ•´ä¸ªç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œä½¿ç”¨è€…éœ€è¦äº†è§£æ¯ä¸€ä¸ªå‚æ•°çš„æ„ä¹‰ï¼Œå¹¶å°†è¿™äº›å‡½æ•°æ‹¼è£…æˆä¸€æ•´ä¸ªç³»ç»Ÿã€‚è¯¦ç»†å¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/lazyconfigs.html">LazyConfig system</a></p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python">model <span class="token operator">=</span> GeneralizedRCNN<span class="token punctuation">(</span>
    backbone<span class="token operator">=</span>FPN<span class="token punctuation">(</span>
        ResNet<span class="token punctuation">(</span>
            BasicStem<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> norm<span class="token operator">=</span><span class="token string">"FrozenBN"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            ResNet<span class="token punctuation">.</span>make_default_stages<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> stride_in_1x1<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> norm<span class="token operator">=</span><span class="token string">"FrozenBN"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            out_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"res2"</span><span class="token punctuation">,</span> <span class="token string">"res3"</span><span class="token punctuation">,</span> <span class="token string">"res4"</span><span class="token punctuation">,</span> <span class="token string">"res5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span>freeze<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">[</span><span class="token string">"res2"</span><span class="token punctuation">,</span> <span class="token string">"res3"</span><span class="token punctuation">,</span> <span class="token string">"res4"</span><span class="token punctuation">,</span> <span class="token string">"res5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token number">256</span><span class="token punctuation">,</span>
        top_block<span class="token operator">=</span>LastLevelMaxPool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    proposal_generator<span class="token operator">=</span>RPN<span class="token punctuation">(</span>
        in_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"p2"</span><span class="token punctuation">,</span> <span class="token string">"p3"</span><span class="token punctuation">,</span> <span class="token string">"p4"</span><span class="token punctuation">,</span> <span class="token string">"p5"</span><span class="token punctuation">,</span> <span class="token string">"p6"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        head<span class="token operator">=</span>StandardRPNHead<span class="token punctuation">(</span>in_channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> num_anchors<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        anchor_generator<span class="token operator">=</span>DefaultAnchorGenerator<span class="token punctuation">(</span>
            sizes<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            aspect_ratios<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">2.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            strides<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            offset<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        anchor_matcher<span class="token operator">=</span>Matcher<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token number">0.7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        box2box_transform<span class="token operator">=</span>Box2BoxTransform<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        batch_size_per_image<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span>
        positive_fraction<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">,</span>
        pre_nms_topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        post_nms_topk<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        nms_thresh<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    roi_heads<span class="token operator">=</span>StandardROIHeads<span class="token punctuation">(</span>
        num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
        batch_size_per_image<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
        positive_fraction<span class="token operator">=</span><span class="token number">0.25</span><span class="token punctuation">,</span>
        proposal_matcher<span class="token operator">=</span>Matcher<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> allow_low_quality_matches<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        box_in_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"p2"</span><span class="token punctuation">,</span> <span class="token string">"p3"</span><span class="token punctuation">,</span> <span class="token string">"p4"</span><span class="token punctuation">,</span> <span class="token string">"p5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        box_pooler<span class="token operator">=</span>ROIPooler<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ROIAlignV2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        box_head<span class="token operator">=</span>FastRCNNConvFCHead<span class="token punctuation">(</span>
            ShapeSpec<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conv_dims<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fc_dims<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        box_predictor<span class="token operator">=</span>FastRCNNOutputLayers<span class="token punctuation">(</span>
            ShapeSpec<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            test_score_thresh<span class="token operator">=</span><span class="token number">0.05</span><span class="token punctuation">,</span>
            box2box_transform<span class="token operator">=</span>Box2BoxTransform<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_in_features<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"p2"</span><span class="token punctuation">,</span> <span class="token string">"p3"</span><span class="token punctuation">,</span> <span class="token string">"p4"</span><span class="token punctuation">,</span> <span class="token string">"p5"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        mask_pooler<span class="token operator">=</span>ROIPooler<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"ROIAlignV2"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        mask_head<span class="token operator">=</span>MaskRCNNConvUpsampleHead<span class="token punctuation">(</span>
            ShapeSpec<span class="token punctuation">(</span>channels<span class="token operator">=</span><span class="token number">256</span><span class="token punctuation">,</span> width<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            num_classes<span class="token operator">=</span><span class="token number">80</span><span class="token punctuation">,</span>
            conv_dims<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
    pixel_mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">103.530</span><span class="token punctuation">,</span> <span class="token number">116.280</span><span class="token punctuation">,</span> <span class="token number">123.675</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    pixel_std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    input_format<span class="token operator">=</span><span class="token string">"BGR"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>é…ç½®ä¸å‡½æ•°çš„ç»“åˆ</p>
<ul>
<li><p>ä¸€å°éƒ¨åˆ†è¢«<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.configurable">@configurable</a>ä¿®é¥°çš„å‡½æ•°ä¸ç±»ï¼Œæ—¢å¯ä»¥è¢«å½“æˆé…ç½®ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥è¢«å½“ä½œå‡½æ•°æ¥å£ä½¿ç”¨ã€‚</p>
</li>
<li><pre class="line-numbers language-python"><code class="language-python">model <span class="token operator">=</span> GeneralizedRCNN<span class="token punctuation">(</span>
  cfg<span class="token punctuation">,</span>
  roi_heads<span class="token operator">=</span>StandardROIHeads<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> batch_size_per_image<span class="token operator">=</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  pixel_std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">57.0</span><span class="token punctuation">,</span> <span class="token number">57.0</span><span class="token punctuation">,</span> <span class="token number">57.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
</ul>
<p>å¦‚æœä½ åƒå®ç°åŸºæœ¬åŠŸèƒ½ï¼Œå¯ä»¥å‚çœ‹<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/getting_started.html">Beginnerâ€™s Tutorial</a>ï¼Œå¦‚æœåƒå°†<code>Detectron2</code>ç”¨åˆ°è‡ªå·±çš„é¡¹ç›®ä¸­å°±éœ€è¦æŸ¥çœ‹</p>
<ul>
<li>Detectron2 includes a few standard datasets. To use custom ones, see <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/datasets.html">Use Custom Datasets</a>.</li>
<li>Detectron2 contains the standard logic that creates a data loader for training/testing from a dataset, but you can write your own as well. See <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/data_loading.html">Use Custom Data Loaders</a>.</li>
<li>Detectron2 implements many standard detection models, and provide ways for you to overwrite their behaviors. See <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/models.html">Use Models</a> and <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/write-models.html">Write Models</a>.</li>
<li>Detectron2 provides a default training loop that is good for common training tasks. You can customize it with hooks, or write your own loop instead. See <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/tutorials/training.html">training</a>.</li>
</ul>
<h2 id="6-è‡ªå®šä¹‰æ•°æ®é›†"><a href="#6-è‡ªå®šä¹‰æ•°æ®é›†" class="headerlink" title="6. è‡ªå®šä¹‰æ•°æ®é›†"></a>6. è‡ªå®šä¹‰æ•°æ®é›†</h2><h3 id="6-1-æ³¨å†Œæ•°æ®é›†"><a href="#6-1-æ³¨å†Œæ•°æ®é›†" class="headerlink" title="6.1 æ³¨å†Œæ•°æ®é›†"></a>6.1 æ³¨å†Œæ•°æ®é›†</h3><p>å®˜ç½‘ä¹Ÿä¸º<code>register</code>è¿™ä¸ªè¯æ„Ÿåˆ°<span class="github-emoji"><span>ğŸ˜…</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ï¼Œå…¶å®å°±æ˜¯æ­å»ºæ•°æ®ç®¡é“ï¼Œè®©<code>Detectron2</code>çŸ¥é“å¦‚ä½•è¯»å–æ•°æ®ã€‚å…·ä½“å°±æ˜¯å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°éœ€è¦èƒ½å¤Ÿè¯»å–æ•°æ®ä¸­çš„æ¯ä¸€ä¸ªæ•°æ®ï¼Œå¹¶å°†è¿™ä¸ªå‡½æ•°ä¸æŒ‡å®šæ–¹æ³•ç»‘å®šã€‚</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">my_dataset_function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token keyword">return</span> list<span class="token punctuation">[</span>dict<span class="token punctuation">]</span> <span class="token keyword">in</span> the following format <span class="token comment" spellcheck="true"># éœ€è¦å®ç°çš„æ–¹æ³•</span>

<span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> DatasetCatalog
DatasetCatalog<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">,</span> my_dataset_function<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># later, to access the data:</span>
data<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span> <span class="token operator">=</span> DatasetCatalog<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true"># å‡½æ•°ç»‘å®š</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="6-2-æ ‡å‡†æ•°æ®å­—å…¸"><a href="#6-2-æ ‡å‡†æ•°æ®å­—å…¸" class="headerlink" title="6.2 æ ‡å‡†æ•°æ®å­—å…¸"></a>6.2 æ ‡å‡†æ•°æ®å­—å…¸</h3><p>å¯¹äºCVä¸­å¸¸è§çš„ä»»åŠ¡ç›®æ ‡æ£€æµ‹ã€å®ä¾‹/è¯­ä¹‰/å…¨æ™¯åˆ†å‰²ã€å…³é”®ç‚¹æ£€æµ‹ï¼Œæ•°æ®çš„æ ¼å¼ä¸COCOçš„æ ¼å¼å¾ˆç›¸è¿‘ï¼Œæ‰€æœ‰çš„æ•°æ®å­˜åœ¨ä¸€ä¸ªliståˆ—è¡¨ä¸­ï¼Œæ¯ä¸ªåˆ—è¡¨æˆå‘˜éƒ½æ˜¯ä¸€ä¸ªå­—å…¸ï¼Œæ€»ä½“è¡¨ç¤ºä¸º<code>list[dict]</code>ã€‚ä¸€èˆ¬çš„å­—å…¸æ•°æ®ä¸ä»»åŠ¡æœ‰å…³ï¼Œå¯ä»¥å‚è€ƒ</p>
<table>
<thead>
<tr>
<th>Task</th>
<th>Fields</th>
</tr>
</thead>
<tbody><tr>
<td>Common</td>
<td>file_name, height, width, image_id</td>
</tr>
<tr>
<td>Instance detection/segmentation</td>
<td>annotations</td>
</tr>
<tr>
<td>Semantic segmentation</td>
<td>sem_seg_file_name</td>
</tr>
<tr>
<td>Panoptic segmentation</td>
<td>pan_seg_file_name, segments_info</td>
</tr>
</tbody></table>
<ul>
<li><p><code>file_name</code>: the full path to the image file.</p>
</li>
<li><p><code>height</code>, <code>width</code>: integer. The shape of the image.</p>
</li>
<li><p><code>image_id</code> (str or int): a unique id that identifies this image. Required by many evaluators to identify the images, but a dataset may use it for different purposes.</p>
</li>
<li><p><code>annotations</code> (list[dict]): Required by <strong>instance detection/segmentation or keypoint detection</strong> tasks. Each dict corresponds to annotations of one instance in this image, and may contain the following keys:</p>
<ul>
<li><p><code>bbox</code> (list[float], required): list of 4 numbers representing the bounding box of the instance.</p>
</li>
<li><p><code>bbox_mode</code> (int, required): the format of bbox. It must be a member of <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/structures.html#detectron2.structures.BoxMode">structures.BoxMode</a>. Currently supports: <code>BoxMode.XYXY_ABS</code>, <code>BoxMode.XYWH_ABS</code>.</p>
</li>
<li><p><code>category_id</code> (int, required): an integer in the range [0, num_categories-1] representing the category label. The value num_categories is reserved to represent the â€œbackgroundâ€ category, if applicable.</p>
</li>
<li><p><code>segmentation</code> (list[list[float]] or dict): the segmentation mask of the instance.</p>
<ul>
<li>If <code>list[list[float]]</code>, it represents a list of polygons, one for each connected component of the object. Each <code>list[float]</code> is one simple polygon in the format of <code>[x1, y1, ..., xn, yn]</code> (nâ‰¥3). The Xs and Ys are absolute coordinates in unit of pixels.</li>
<li>If <code>dict</code>, it represents the per-pixel segmentation mask in COCOâ€™s compressed RLE format. The dict should have keys â€œsizeâ€ and â€œcountsâ€. You can convert a uint8 segmentation mask of 0s and 1s into such dict by <code>pycocotools.mask.encode(np.asarray(mask, order="F"))</code>. <code>cfg.INPUT.MASK_FORMAT</code> must be set to <code>bitmask</code> if using the default data loader with such format.</li>
</ul>
</li>
<li><p><code>keypoints</code> (list[float]): in the format of [x1, y1, v1,â€¦, xn, yn, vn]. v[i] means the <a target="_blank" rel="noopener" href="http://cocodataset.org/#format-data">visibility</a> of this keypoint. <code>n</code> must be equal to the number of keypoint categories. The Xs and Ys are absolute real-value coordinates in range [0, W or H].</p>
<p>(Note that the keypoint coordinates in COCO format are integers in range [0, W-1 or H-1], which is different from our standard format. Detectron2 adds 0.5 to COCO keypoint coordinates to convert them from discrete pixel indices to floating point coordinates.)</p>
</li>
<li><p><code>iscrowd</code>: 0 (default) or 1. Whether this instance is labeled as COCOâ€™s â€œcrowd regionâ€. Donâ€™t include this field if you donâ€™t know what it means.</p>
</li>
</ul>
<p>If <code>annotations</code> is an empty list, it means the image is labeled to have no objects. Such images will by default be removed from training, but can be included using <code>DATALOADER.FILTER_EMPTY_ANNOTATIONS</code>.</p>
</li>
<li><p><code>sem_seg_file_name</code> (str): The full path to the semantic segmentation ground truth file. It should be a grayscale image whose pixel values are integer labels.</p>
</li>
<li><p><code>pan_seg_file_name</code> (str): The full path to panoptic segmentation ground truth file. It should be an RGB image whose pixel values are integer ids encoded using the <a target="_blank" rel="noopener" href="https://github.com/cocodataset/panopticapi/">panopticapi.utils.id2rgb</a> function. The ids are defined by <code>segments_info</code>. If an id does not appear in <code>segments_info</code>, the pixel is considered unlabeled and is usually ignored in training &amp; evaluation.</p>
</li>
<li><p><code>segments_info</code> (list[dict]): defines the meaning of each id in panoptic segmentation ground truth. Each dict has the following keys:</p>
<ul>
<li><code>id</code> (int): integer that appears in the ground truth image.</li>
<li><code>category_id</code> (int): an integer in the range [0, num_categories-1] representing the category label.</li>
<li><code>iscrowd</code>: 0 (default) or 1. Whether this instance is labeled as COCOâ€™s â€œcrowd regionâ€.</li>
</ul>
</li>
</ul>
<p>è¿™æ²¡ä»€ä¹ˆå¥½è§£é‡Šçš„äº†â€¦â€¦</p>
<p>å¦‚æœåƒè®­ç»ƒä¸€ä¸ªFast R-CNNè¿˜éœ€è¦æä¾›æ ¼å¤–çš„æ•°æ®</p>
<ul>
<li><code>proposal_boxes</code> (array): 2D numpy array with shape (K, 4) representing K precomputed proposal boxes for this image.</li>
<li><code>proposal_objectness_logits</code> (array): numpy array with shape (K, ), which corresponds to the objectness logits of proposals in â€˜proposal_boxesâ€™.</li>
<li><code>proposal_bbox_mode</code> (int): the format of the precomputed proposal bbox. It must be a member of <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/structures.html#detectron2.structures.BoxMode">structures.BoxMode</a>. Default is <code>BoxMode.XYXY_ABS</code>.</li>
</ul>
<p>æ€»çš„è¯´æ¥ï¼Œå…·ä½“ä»»åŠ¡çš„æ•°æ®åŸºæœ¬æ˜¯é€šç”¨çš„ï¼Œå¦‚æœæœ‰ä¾‹å¤–ï¼Œè‡ªå·±æ·»åŠ å³å¯ã€‚</p>
<h3 id="6-3-ä¸ºæ–°ä»»åŠ¡è‡ªå®šä¹‰æ•°æ®å­—å…¸"><a href="#6-3-ä¸ºæ–°ä»»åŠ¡è‡ªå®šä¹‰æ•°æ®å­—å…¸" class="headerlink" title="6.3 ä¸ºæ–°ä»»åŠ¡è‡ªå®šä¹‰æ•°æ®å­—å…¸"></a>6.3 ä¸ºæ–°ä»»åŠ¡è‡ªå®šä¹‰æ•°æ®å­—å…¸</h3><p>è¿™å¯èƒ½éœ€è¦ä¿®æ”¹åç»­çš„å¤„ç†ï¼Œä½†æ˜¯åœ¨æ•°æ®éƒ¨åˆ†ï¼Œåªéœ€è¦ä¿®æ”¹ä¸º<code>dataloader</code>å†™ä¸€ä¸ªæ–°çš„<code>mapper</code>å‡½æ•°ã€‚éœ€è¦æ³¨æ„çš„æ˜¯æ•°æ®å­—å…¸å®Œæ•´çš„ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œä¸è¦å†™å¤ªå¤šçš„æ— ç”¨ä¿¡æ¯æˆ–åŠ è½½å¤ªå¤§çš„ä¿¡æ¯ä½œä¸ºæ ‡ç­¾ã€‚å¯¹äºä¸€äº›å…±äº«çš„ä¿¡æ¯ï¼Œä½¿ç”¨<code>Metadata</code>ã€‚<br>æ³¨æ„äº‹é¡¹æ±‡æ€»</p>
<ol>
<li>æ•°æ®å­—å…¸åŠ è½½åœ¨å†…å­˜ä¸­</li>
<li>ä¸è¦åŠ è½½å¤ªå¤šï¼Œå¤ªå¤§çš„ä¿¡æ¯</li>
<li>å…±äº«çš„ä¿¡æ¯ï¼Œç”¨<code>Metadata</code></li>
</ol>
<h3 id="6-4-æ•°æ®é›†ä¸­çš„Metadata"><a href="#6-4-æ•°æ®é›†ä¸­çš„Metadata" class="headerlink" title="6.4 æ•°æ®é›†ä¸­çš„Metadata"></a>6.4 æ•°æ®é›†ä¸­çš„<code>Metadata</code></h3><p>æ¯ä¸ªæ•°æ®é›†éƒ½åŒ…å«ä¸€äº›å…ƒä¿¡æ¯ï¼ˆmetadataï¼‰ï¼Œå¯ä»¥é€šè¿‡<code>MetadataCatalog.get(dataset_name).some_metadata</code>è·å–ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼ä¿å­˜æ•°æ®ï¼Œå¸¸è§çš„ä¿¡æ¯ï¼šç±»çš„åç§°ï¼Œé¢œè‰²ï¼Œæ–‡ä»¶çš„æ ¹ç›®å½•ç­‰ã€‚è¿™äº›ä¿¡æ¯è¢«ç”¨æ¥å½“åšå‡½æ•°å‚æ•°ï¼Œè¯„ä»·æŒ‡æ ‡ï¼Œå¯è§†åŒ–ä¿¡æ¯ä»¥åŠè®°è½½æ—¥å¿—ç­‰ã€‚</p>
<p>ä¸€èˆ¬æµç¨‹ä¸ºï¼Œå…ˆé€šè¿‡<code>DatasetCatalog.register</code>æ³¨å†Œä¸€ä¸ªæ–°çš„æ•°æ®é›†ï¼Œå†é€šè¿‡<code>MetadataCatalog.get(dataset_name).some_key = some_value</code>æ·»åŠ å…ƒä¿¡æ¯</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> MetadataCatalog
MetadataCatalog<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>thing_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"person"</span><span class="token punctuation">,</span> <span class="token string">"dog"</span><span class="token punctuation">]</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ä¸‹è¡¨æ˜¯åœ¨<code>Detectron2</code>é¡¹ç›®ä¸­å¸¸ç”¨çš„å…ƒä¿¡æ¯ï¼Œå¦‚æœä¸éµå¾ªä»¥ä¸‹å»ºè®®ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸€äº›åŠŸèƒ½ç‰¹æ€§æ— æ³•ä½¿ç”¨ã€‚ï¼ˆè¾•ä¿¡æ¯çš„é”®å€¼å¯¹æ˜¯é«˜åº¦è‡ªç”±å®šä¹‰çš„ï¼Œæ‰€ä»¥éœ€è¦ä½ ä¸å®˜æ–¹å‘½åä¿æŒä¸€è‡´ï¼Œæ–¹ä¾¿ä½¿ç”¨å®˜æ–¹çš„åŠŸèƒ½ï¼‰</p>
<ul>
<li><code>thing_classes</code> (list[str]): Used by all instance detection/segmentation tasks. A list of names for each instance/thing category. If you load a COCO format dataset, it will be automatically set by the function <code>load_coco_json</code>.</li>
<li><code>thing_colors</code> (list[tuple(r, g, b)]): Pre-defined color (in [0, 255]) for each thing category. Used for visualization. If not given, random colors will be used.</li>
<li><code>stuff_classes</code> (list[str]): Used by semantic and panoptic segmentation tasks. A list of names for each stuff category.</li>
<li><code>stuff_colors</code> (list[tuple(r, g, b)]): Pre-defined color (in [0, 255]) for each stuff category. Used for visualization. If not given, random colors are used.</li>
<li><code>ignore_label</code> (int): Used by semantic and panoptic segmentation tasks. Pixels in ground-truth annotations with this category label should be ignored in evaluation. Typically these are â€œunlabeledâ€ pixels.</li>
<li><code>keypoint_names</code> (list[str]): Used by keypoint detection. A list of names for each keypoint.</li>
<li><code>keypoint_flip_map</code> (list[tuple[str]]): Used by keypoint detection. A list of pairs of names, where each pair are the two keypoints that should be flipped if the image is flipped horizontally during augmentation.</li>
<li><code>keypoint_connection_rules</code>: list[tuple(str, str, (r, g, b))]. Each tuple specifies a pair of keypoints that are connected and the color (in [0, 255]) to use for the line between them when visualized.</li>
</ul>
<p>ä¸€äº›é¢å¤–çš„ä¿¡æ¯æ˜¯é’ˆå¯¹ç‰¹å®šæ•°æ®é›†ï¼ˆæ¯”å¦‚COCOï¼‰çš„éªŒè¯è¿‡ç¨‹ï¼š</p>
<ul>
<li><code>thing_dataset_id_to_contiguous_id</code> (dict[int-&gt;int]): Used by all instance detection/segmentation tasks in the COCO format. A mapping from instance class ids in the dataset to contiguous ids in range [0, #class). Will be automatically set by the function <code>load_coco_json</code>.</li>
<li><code>stuff_dataset_id_to_contiguous_id</code> (dict[int-&gt;int]): Used when generating prediction json files for semantic/panoptic segmentation. A mapping from semantic segmentation class ids in the dataset to contiguous ids in [0, num_categories). It is useful for evaluation only.</li>
<li><code>json_file</code>: The COCO annotation json file. Used by COCO evaluation for COCO-format datasets.</li>
<li><code>panoptic_root</code>, <code>panoptic_json</code>: Used by COCO-format panoptic evaluation.</li>
<li><code>evaluator_type</code>: Used by the builtin main training script to select evaluator. Donâ€™t use it in a new training script. You can just provide the <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/evaluation.html#detectron2.evaluation.DatasetEvaluator">DatasetEvaluator</a> for your dataset directly in your main script.</li>
</ul>
<h3 id="6-5-COCOæ ¼å¼çš„æ•°æ®é›†"><a href="#6-5-COCOæ ¼å¼çš„æ•°æ®é›†" class="headerlink" title="6.5 COCOæ ¼å¼çš„æ•°æ®é›†"></a>6.5 COCOæ ¼å¼çš„æ•°æ®é›†</h3><p>å¦‚æœå®ä¾‹çº§åˆ«æ•°æ®å·²ç»æŒ‰ç…§COCOçš„æ ¼å¼ä¿å­˜ä¸ºä¸€ä¸ª<code>json</code>æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±èƒ½å¾ˆç®€å•çš„æ³¨å†Œè¿™ä¸ªæ•°æ®é›†</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>datasets <span class="token keyword">import</span> register_coco_instances
register_coco_instances<span class="token punctuation">(</span><span class="token string">"my_dataset"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"json_annotation.json"</span><span class="token punctuation">,</span> <span class="token string">"path/to/image/dir"</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>å¦‚æœæ•°æ®å·²ç»æ˜¯COCOæ ¼å¼ï¼Œä½†æ˜¯æƒ³è¦æ›´æ·±å…¥çš„å¤„ç†ï¼Œæˆ–æœ‰é¢å¤–è‡ªå®šä¹‰çš„å®ä¾‹æ ‡æ³¨ï¼Œå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/data.html#detectron2.data.datasets.load_coco_json">load_coco_json</a></p>
<h3 id="6-6-æ›´æ–°æ•°æ®é›†çš„é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦é‡å†™ï¼‰"><a href="#6-6-æ›´æ–°æ•°æ®é›†çš„é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦é‡å†™ï¼‰" class="headerlink" title="6.6 æ›´æ–°æ•°æ®é›†çš„é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦é‡å†™ï¼‰"></a>6.6 æ›´æ–°æ•°æ®é›†çš„é…ç½®æ–‡ä»¶ï¼ˆéœ€è¦é‡å†™ï¼‰</h3><p>å½“ä½ å®Œæˆæ•°æ®é›†çš„æ³¨å†Œåï¼Œå¯ä»¥åœ¨<code>cfg.DATASETS.{TRAIN,TEST}</code>ä¸­ä½¿ç”¨ä½ è‡ªå®šä¹‰çš„æ•°æ®é›†åç§°ã€‚å…¶ä»–é…ç½®æ–‡ä»¶ä¿®æ”¹</p>
<ul>
<li><code>MODEL.ROI_HEADS.NUM_CLASSES</code> and <code>MODEL.RETINANET.NUM_CLASSES</code> are the number of thing classes for R-CNN and RetinaNet models, respectively.</li>
<li><code>MODEL.ROI_KEYPOINT_HEAD.NUM_KEYPOINTS</code> sets the number of keypoints for Keypoint R-CNN. Youâ€™ll also need to set <a target="_blank" rel="noopener" href="http://cocodataset.org/#keypoints-eval">Keypoint OKS</a> with <code>TEST.KEYPOINT_OKS_SIGMAS</code> for evaluation.</li>
<li><code>MODEL.SEM_SEG_HEAD.NUM_CLASSES</code> sets the number of stuff classes for Semantic FPN &amp; Panoptic FPN.</li>
<li><code>TEST.DETECTIONS_PER_IMAGE</code> controls the maximum number of objects to be detected. Set it to a larger number if test images may contain &gt;100 objects.</li>
<li>If youâ€™re training Fast R-CNN (with precomputed proposals), <code>DATASETS.PROPOSAL_FILES_{TRAIN,TEST}</code> need to match the datasets. The format of proposal files are documented <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/data.html#detectron2.data.load_proposals_into_dataset">here</a>.</li>
</ul>
<h2 id="7-æ•°æ®åŠ è½½å™¨"><a href="#7-æ•°æ®åŠ è½½å™¨" class="headerlink" title="7. æ•°æ®åŠ è½½å™¨"></a>7. æ•°æ®åŠ è½½å™¨</h2><p>æ•°æ®åŠ è½½å™¨è´Ÿè´£å°†æ•°æ®é€å…¥æ¨¡å‹ã€‚é€šå¸¸ä¸€ä¸ªåŠ è½½å™¨éœ€è¦è´Ÿè´£ä»æ•°æ®é›†ä¸­æå–åŸå§‹æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œé¢„å¤„ç†ï¼Œå°†æ•°æ®å˜æˆæ¨¡å‹èƒ½å¤Ÿæ¥å—çš„æ•°æ®ã€‚<br>$$<br>Dataloader = æå–æ•°æ®ï¼ˆç¡¬ç›˜åˆ°å†…å­˜ï¼‰+æ•°æ®é¢„å¤„ç†+ä¼ å…¥æ¨¡å‹<br>$$</p>
<h3 id="7-1-æ•°æ®åŠ è½½å™¨çš„å·¥ä½œåŸç†"><a href="#7-1-æ•°æ®åŠ è½½å™¨çš„å·¥ä½œåŸç†" class="headerlink" title="7.1 æ•°æ®åŠ è½½å™¨çš„å·¥ä½œåŸç†"></a>7.1 æ•°æ®åŠ è½½å™¨çš„å·¥ä½œåŸç†</h3><ol>
<li><p>é¦–å…ˆé€šè¿‡æ•°æ®é›†çš„æ³¨å†Œåï¼ŒåŠ è½½æ•°æ®å­—å…¸<code>list[dict]</code>(è½»é‡çº§ï¼Œå›¾åƒæ•°æ®è¿˜æ²¡æœ‰åŠ è½½è¿›å…¥å†…å­˜)ã€‚</p>
</li>
<li><p>å¯¹æ•°æ®å­—å…¸ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œmapæ˜ å°„ï¼ˆå¯ä»¥ç†è§£ä¸ºåŒæ—¶å¯¹å¤šå¼ å›¾ç‰‡è¿›è¡Œå¹¶è¡ŒåŒ–çš„é¢„å¤„ç†ï¼‰</p>
<ul>
<li>ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ˜ å°„å‡½æ•°ï¼Œé»˜è®¤ä¸º<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/data.html#detectron2.data.DatasetMapper">DatasetMapper</a>ã€‚</li>
<li>æ‰¹å¤„ç†æ˜ å°„å¾—åˆ°çš„ç»“æœå¯ä»¥æ˜¯ä»»æ„çš„ï¼Œåªè¦æ ¼å¼èƒ½å¤Ÿè¢«ç½‘ç»œæ¥å—ã€‚</li>
<li>mapperçš„ä½œç”¨æ˜¯å¯¹å›¾åƒè¿›è¡Œé¢„å¤„ç†ï¼Œå¦‚æœæƒ³è¦å¯¹å›¾åƒè¿›è¡Œè‡ªå®šä¹‰å˜æ¢ï¼Œéœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªmapper</li>
</ul>
</li>
<li><p>mapperæ˜¯åŸºäºæ‰¹å¤„ç†çš„</p>
</li>
<li><p>mapperçš„ç»“æœä¹Ÿæ˜¯Dataloaderçš„ç»“æœï¼Œä¸€èˆ¬ä¹Ÿæ˜¯æ¨¡å‹çš„è¾“å…¥</p>
</li>
</ol>
<h3 id="7-2-è‡ªå®šä¹‰æ•°æ®åŠ è½½å™¨"><a href="#7-2-è‡ªå®šä¹‰æ•°æ®åŠ è½½å™¨" class="headerlink" title="7.2 è‡ªå®šä¹‰æ•°æ®åŠ è½½å™¨"></a>7.2 è‡ªå®šä¹‰æ•°æ®åŠ è½½å™¨</h3><p>ç¼©æ”¾å›¾åƒ</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">import</span> detectron2<span class="token punctuation">.</span>data<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> T
<span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> DatasetMapper   <span class="token comment" spellcheck="true"># the default mapper</span>
dataloader <span class="token operator">=</span> build_detection_train_loader<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span>
   mapper<span class="token operator">=</span>DatasetMapper<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> is_train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> augmentations<span class="token operator">=</span><span class="token punctuation">[</span>
      T<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># use this dataloader instead of the default</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è‡ªå®šä¹‰</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>data <span class="token keyword">import</span> detection_utils <span class="token keyword">as</span> utils
 <span class="token comment" spellcheck="true"># Show how to implement a minimal mapper, similar to the default DatasetMapper</span>
<span class="token keyword">def</span> <span class="token function">mapper</span><span class="token punctuation">(</span>dataset_dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dataset_dict <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>dataset_dict<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># it will be modified by code below</span>
    <span class="token comment" spellcheck="true"># can use other ways to read image</span>
    image <span class="token operator">=</span> utils<span class="token punctuation">.</span>read_image<span class="token punctuation">(</span>dataset_dict<span class="token punctuation">[</span><span class="token string">"file_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> format<span class="token operator">=</span><span class="token string">"BGR"</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># See "Data Augmentation" tutorial for details usage</span>
    auginput <span class="token operator">=</span> T<span class="token punctuation">.</span>AugInput<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    transform <span class="token operator">=</span> T<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span>auginput<span class="token punctuation">)</span>
    image <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>auginput<span class="token punctuation">.</span>image<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    annos <span class="token operator">=</span> <span class="token punctuation">[</span>
        utils<span class="token punctuation">.</span>transform_instance_annotations<span class="token punctuation">(</span>annotation<span class="token punctuation">,</span> <span class="token punctuation">[</span>transform<span class="token punctuation">]</span><span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> annotation <span class="token keyword">in</span> dataset_dict<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">"annotations"</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true"># create the format that the model expects</span>
       <span class="token string">"image"</span><span class="token punctuation">:</span> image<span class="token punctuation">,</span>
       <span class="token string">"instances"</span><span class="token punctuation">:</span> utils<span class="token punctuation">.</span>annotations_to_instances<span class="token punctuation">(</span>annos<span class="token punctuation">,</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
dataloader <span class="token operator">=</span> build_detection_train_loader<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> mapper<span class="token operator">=</span>mapper<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>   å¦‚æœæƒ³è¦ä¿®æ”¹çš„ä¸ä»…ä»…æ˜¯mapperï¼Œé‚£ä¹ˆå°±éœ€è¦é‡å†™ä¸€ä¸ªdataloaderï¼Œdataloaderæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªpythonè¿­ä»£å™¨ï¼Œæ— è®ºç”¨ä»€ä¹ˆæ–¹å¼éƒ½å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªã€‚</p>
<h2 id="8-æ•°æ®å¢å¼ºï¼ˆæœªå®Œæˆï¼‰ç¼ºå°‘å®æˆ˜ç†è§£"><a href="#8-æ•°æ®å¢å¼ºï¼ˆæœªå®Œæˆï¼‰ç¼ºå°‘å®æˆ˜ç†è§£" class="headerlink" title="8. æ•°æ®å¢å¼ºï¼ˆæœªå®Œæˆï¼‰ç¼ºå°‘å®æˆ˜ç†è§£"></a>8. æ•°æ®å¢å¼ºï¼ˆæœªå®Œæˆï¼‰ç¼ºå°‘å®æˆ˜ç†è§£</h2><p>æ•°æ®å¢å¼ºæ˜¯è®­ç»ƒçš„å¾ˆé‡è¦ä¸€éƒ¨åˆ†ï¼Œ<code>Detectron2</code>é€šè¿‡å®ç°ä»¥ä¸‹å››ä¸ªç‰¹æ€§ï¼ˆåŠŸèƒ½ï¼‰æ¥å®ç°æ•°æ®å¢å¼ºåŠŸèƒ½ã€‚</p>
<ol>
<li>åŒæ—¶å¢å¼ºæ‰€æœ‰ç±»å‹çš„æ•°æ®ï¼ˆåŸå›¾åƒï¼Œç›®æ ‡æ£€æµ‹æ¡†ï¼Œæ©è†œç­‰ä¿¡æ¯ä¸€èµ·å˜åŒ–ï¼‰</li>
<li>é™æ€æ•°æ®å¢å¼ºå£°æ˜ï¼ˆå°†å¾ˆå¤šçš„å˜åŒ–æŒ‰ç…§é¡ºåºæ’åˆ—ï¼‰</li>
<li>å…è®¸å¢åŠ æ–°çš„æ•°æ®ç±»å‹è¿›è¡Œæ•°æ®å¢å¼ºã€‚ï¼ˆé™¤äº†1ä¸­åŒ…å«çš„ä¿¡æ¯ï¼Œä¹Ÿå…è®¸è‡ªå®šä¹‰ï¼‰</li>
<li>ä»…é€šè¿‡å‚æ•°è®¾ç½®è¿›è¡Œå¢å¼º</li>
</ol>
<h3 id="8-1-åŸºç¡€ä½¿ç”¨"><a href="#8-1-åŸºç¡€ä½¿ç”¨" class="headerlink" title="8.1 åŸºç¡€ä½¿ç”¨"></a>8.1 åŸºç¡€ä½¿ç”¨</h3><p>ä¸»è¦ä¾èµ–ç‰¹æ€§1å’Œ2</p>
<pre><code>from detectron2.data import transforms as T
# Define a sequence of augmentations:
augs = T.AugmentationList([
    T.RandomBrightness(0.9, 1.1),
    T.RandomFlip(prob=0.5),
    T.RandomCrop("absolute", (640, 640))
])  # type: T.Augmentation

# Define the augmentation input ("image" required, others optional):
input = T.AugInput(image, boxes=boxes, sem_seg=sem_seg)
# Apply the augmentation:
transform = augs(input)  # type: T.Transform
image_transformed = input.image  # new image
sem_seg_transformed = input.sem_seg  # new semantic segmentation

# For any extra data that needs to be augmented together, use transform, e.g.:
image2_transformed = transform.apply_image(image2)
polygons_transformed = transform.apply_polygons(polygons)
</code></pre>
<h3 id="8-2-è‡ªå®šä¹‰å¢å¼ºå‡½æ•°"><a href="#8-2-è‡ªå®šä¹‰å¢å¼ºå‡½æ•°" class="headerlink" title="8.2 è‡ªå®šä¹‰å¢å¼ºå‡½æ•°"></a>8.2 è‡ªå®šä¹‰å¢å¼ºå‡½æ•°</h3><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">MyColorAugmentation</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span>Augmentation<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_transform</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        r <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> T<span class="token punctuation">.</span>ColorTransform<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x <span class="token operator">*</span> r<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> r<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">MyCustomResize</span><span class="token punctuation">(</span>T<span class="token punctuation">.</span>Augmentation<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">get_transform</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        old_h<span class="token punctuation">,</span> old_w <span class="token operator">=</span> image<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        new_h<span class="token punctuation">,</span> new_w <span class="token operator">=</span> int<span class="token punctuation">(</span>old_h <span class="token operator">*</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> int<span class="token punctuation">(</span>old_w <span class="token operator">*</span> <span class="token number">1.5</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> T<span class="token punctuation">.</span>ResizeTransform<span class="token punctuation">(</span>old_h<span class="token punctuation">,</span> old_w<span class="token punctuation">,</span> new_h<span class="token punctuation">,</span> new_w<span class="token punctuation">)</span>

augs <span class="token operator">=</span> MyCustomResize<span class="token punctuation">(</span><span class="token punctuation">)</span>
transform <span class="token operator">=</span> augs<span class="token punctuation">(</span>input<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>class MyCustomCrop(T.Augmentation):
    def get_transform(self, image, sem_seg):
        # decide where to crop using both image and sem_seg
        return T.CropTransform(...)

augs = MyCustomCrop()
assert hasattr(input, "image") and hasattr(input, "sem_seg")
transform = augs(input)
</code></pre>
<h3 id="8-3-é«˜çº§ç”¨æ³•"><a href="#8-3-é«˜çº§ç”¨æ³•" class="headerlink" title="8.3 é«˜çº§ç”¨æ³•"></a>8.3 é«˜çº§ç”¨æ³•</h3><h2 id="9-ç¼–å†™æ¨¡å‹"><a href="#9-ç¼–å†™æ¨¡å‹" class="headerlink" title="9. ç¼–å†™æ¨¡å‹"></a>9. ç¼–å†™æ¨¡å‹</h2><p>å¾ˆå¤šç ”ç©¶å·¥ä½œéƒ½éœ€è¦ä»å¤´å¼€å§‹å®ç°åŠŸèƒ½ï¼Œä½†æ˜¯å¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥å€ŸåŠ©è¦†å†™æ ‡å‡†æ¨¡å‹çš„æ¨¡å—æ¥å®ç°ã€‚</p>
<h3 id="9-1-æ³¨å†Œç»„ä»¶"><a href="#9-1-æ³¨å†Œç»„ä»¶" class="headerlink" title="9.1 æ³¨å†Œç»„ä»¶"></a>9.1 æ³¨å†Œç»„ä»¶</h3><p>å®Œæ•´çš„ç½‘ç»œä¾æ®åŠŸèƒ½å¸¸å¸¸è¢«åˆ†ä¸º<code>Backbone</code>ï¼Œ<code>box head</code>ç­‰ï¼Œå¯ä»¥é€šè¿‡<code>Detectron2</code>å®ç°ç»„ä»¶çš„è¦†å†™ã€‚ä»¥æ·»åŠ æ–°çš„baskboneä¸ºä¾‹</p>
<p>å®šä¹‰</p>
<pre><code>from detectron2.modeling import BACKBONE_REGISTRY, Backbone, ShapeSpec

@BACKBONE_REGISTRY.register()
class ToyBackbone(Backbone):
  def __init__(self, cfg, input_shape):
    super().__init__()
    # create your own backbone
    self.conv1 = nn.Conv2d(3, 64, kernel_size=7, stride=16, padding=3)

  def forward(self, image):
    return {"conv1": self.conv1(image)}

  def output_shape(self):
    return {"conv1": ShapeSpec(channels=64, stride=16)}
</code></pre>
<p>ä½¿ç”¨</p>
<pre><code>cfg = ...   # read a config
cfg.MODEL.BACKBONE.NAME = 'ToyBackbone'   # or set it in the config file
model = build_model(cfg)  # it will find `ToyBackbone` defined above
</code></pre>
<h3 id="9-2-æ˜¾ç¤ºè°ƒç”¨"><a href="#9-2-æ˜¾ç¤ºè°ƒç”¨" class="headerlink" title="9.2 æ˜¾ç¤ºè°ƒç”¨"></a>9.2 æ˜¾ç¤ºè°ƒç”¨</h3><p>é€šè¿‡æ³¨å†Œè¡¨è™½ç„¶èƒ½å®ç°ä¸€äº›åŠŸèƒ½ï¼Œä½†æ˜¯æƒ³æ›´åŠ ç»†èŠ‚çš„ï¼Œè¿˜æ˜¯éœ€è¦è‡ªå·±å®ç°ã€‚detectron2ä¸­çš„ç»„ä»¶éƒ½æœ‰<code>__init__</code>å±æ€§ï¼Œé€šè¿‡è¿™ä¸ªå±æ€§å°±èƒ½çŸ¥é“æ¥å—çš„å‚æ•°ã€‚</p>
<p>ä»¥Faster R-CNNä¸ºä¾‹ï¼Œè‡ªå®šä¹‰å…¶ä¸­box headçš„æŸå¤±å‡½æ•°</p>
<ol>
<li><p>æŸå¤±å‡½æ•°åœ¨FastRCNNOutputLayersä¸­è®¡ç®—ï¼Œéœ€è¦ç»§æ‰¿å®ç°è¿™ä¸ªç±»ï¼Œæš‚æ—¶å°†è¿™ä¸ªå‡½æ•°å‘½åä¸º<code>myRCNNOutput</code></p>
</li>
<li><p>ä½¿ç”¨</p>
<pre><code>roi_heads = StandardROIHeads(
  cfg, backbone.output_shape(),
  box_predictor=MyRCNNOutput(...)
)
</code></pre>
</li>
<li><p>å¦‚æœæƒ³è¦ç¡®ä¿æ–°ç»„ä»¶ä»é…ç½®æ–‡ä»¶ä¸­è€Œæ¥ï¼Œé‚£å°±éœ€è¦æ³¨å†Œ</p>
<pre class="line-numbers language-python"><code class="language-python">@ROI_HEADS_REGISTRY<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">MyStandardROIHeads</span><span class="token punctuation">(</span>StandardROIHeads<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cfg<span class="token punctuation">,</span> input_shape<span class="token punctuation">)</span><span class="token punctuation">:</span>
    super<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>cfg<span class="token punctuation">,</span> input_shape<span class="token punctuation">,</span>
                     box_predictor<span class="token operator">=</span>MyRCNNOutput<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<h2 id="10-è®­ç»ƒ"><a href="#10-è®­ç»ƒ" class="headerlink" title="10. è®­ç»ƒ"></a>10. è®­ç»ƒ</h2><p>ç»è¿‡ä¸Šé¢è¿™äº›å†…å®¹çš„å­¦ä¹ ï¼Œå·²ç»èƒ½å¤Ÿå®ŒæˆDataloaderå’ŒModelçš„æ­å»ºçš„ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è®­ç»ƒè¿‡ç¨‹äº†ã€‚æœ‰ä¸¤ç§é£æ ¼çš„ä»£ç ã€‚</p>
<h3 id="10-1-è‡ªå®šä¹‰å¾ªç¯è®­ç»ƒ"><a href="#10-1-è‡ªå®šä¹‰å¾ªç¯è®­ç»ƒ" class="headerlink" title="10.1 è‡ªå®šä¹‰å¾ªç¯è®­ç»ƒ"></a>10.1 è‡ªå®šä¹‰å¾ªç¯è®­ç»ƒ</h3><p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/tools/plain_train_net.py">tools/plain_train_net.py</a>å®Œå…¨æ˜¯pytorché£æ ¼çš„ï¼Œç”¨æˆ·æœ‰æå¤§çš„è‡ªç”±ã€‚</p>
<h3 id="10-2-æŠ½è±¡è®­ç»ƒå™¨"><a href="#10-2-æŠ½è±¡è®­ç»ƒå™¨" class="headerlink" title="10.2 æŠ½è±¡è®­ç»ƒå™¨"></a>10.2 æŠ½è±¡è®­ç»ƒå™¨</h3><p>Detectron2æä¾›äº†ä¸€ä¸ªæ ‡å‡†çš„è®­ç»ƒå™¨ï¼Œå®ƒå¸¦æœ‰hookç³»ç»Ÿï¼Œèƒ½å¤Ÿç®€åŒ–è®­ç»ƒè¿‡ç¨‹ï¼Œä¸»è¦åŒ…å«ä¸¤ç§å®ä¾‹åŒ–ã€‚</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.SimpleTrainer">SimpleTrainer</a>ä¸ºå•æ•°æ®æºï¼Œå•ä¼˜åŒ–å™¨ï¼Œå•æ•°æ®æºçš„æƒ…å†µæä¾›äº†ä¸€ä¸ªæœ€å°è®­ç»ƒå¾ªç¯ã€‚å¦‚æœè¿˜æƒ³è¦checkpointï¼ˆæ¨¡å‹ä¿å­˜ä¸åŠ è½½ï¼‰ï¼Œæ—¥å¿—è®°å½•ç­‰ï¼Œå°±éœ€è¦ä½¿ç”¨hookç³»ç»Ÿï¼Œå‚è€ƒ<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.HookBase">hook system</a>.</li>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.defaults.DefaultTrainer">DefaultTrainer</a>æ˜¯ä¸€ä¸ªç”±yacsé…ç½®åˆå§‹åŒ–çš„SimpleTrainerï¼Œè¢«tools/train_net.pyå’Œè®¸å¤šè„šæœ¬ä½¿ç”¨ã€‚å®ƒåŒ…å«äº†æ›´å¤šæ ‡å‡†çš„é»˜è®¤è¡Œä¸ºï¼ŒåŒ…æ‹¬ä¼˜åŒ–å™¨çš„é»˜è®¤é…ç½®ï¼Œå­¦ä¹ é€Ÿåº¦è®¡åˆ’ï¼Œæ—¥å¿—ï¼Œè¯„ä¼°ï¼Œæ£€æŸ¥ç‚¹ç­‰ã€‚</li>
</ol>
<p>è‡ªå®šä¹‰ä¸€ä¸ªDefaultTrainerã€‚</p>
<ol>
<li><p>For simple customizations (e.g. change optimizer, evaluator, LR scheduler, data loader, etc.), overwrite <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.defaults.DefaultTrainer">its methods</a> in a subclass, just like <a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/tools/train_net.py">tools/train_net.py</a>.</p>
</li>
<li><p>For extra tasks during training, check the <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/engine.html#detectron2.engine.HookBase">hook system</a> to see if itâ€™s supported.</p>
<p>As an example, to print hello during training:</p>
<pre><code>class HelloHook(HookBase):
  def after_step(self):
    if self.trainer.iter % 100 == 0:
      print(f"Hello at iteration {self.trainer.iter}!")
</code></pre>
</li>
<li><p>Using a trainer+hook system means there will always be some non-standard behaviors that cannot be supported, especially in research. For this reason, we intentionally keep the trainer &amp; hook system minimal, rather than powerful. If anything cannot be achieved by such a system, itâ€™s easier to start from <a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/tools/plain_train_net.py">tools/plain_train_net.py</a> to implement custom training logic manually.</p>
</li>
</ol>
<h3 id="10-3-æ—¥å¿—è®°å½•æŒ‡æ ‡"><a href="#10-3-æ—¥å¿—è®°å½•æŒ‡æ ‡" class="headerlink" title="10.3 æ—¥å¿—è®°å½•æŒ‡æ ‡"></a>10.3 æ—¥å¿—è®°å½•æŒ‡æ ‡</h3><p>åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œè¯„ä»·æŒ‡æ ‡æ•°æ®è¢«æ”¾åœ¨é›†ä¸­äº‹ä»¶å­˜å‚¨ <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/utils.html#detectron2.utils.events.EventStorage">EventStorage</a>ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç è°ƒç”¨ </p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>events <span class="token keyword">import</span> get_event_storage

<span class="token comment" spellcheck="true"># inside the model:</span>
<span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
  value <span class="token operator">=</span> <span class="token comment" spellcheck="true"># compute the value from inputs</span>
  storage <span class="token operator">=</span> get_event_storage<span class="token punctuation">(</span><span class="token punctuation">)</span>
  storage<span class="token punctuation">.</span>put_scalar<span class="token punctuation">(</span><span class="token string">"some_accuracy"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="11-è¯„ä»·"><a href="#11-è¯„ä»·" class="headerlink" title="11. è¯„ä»·"></a>11. è¯„ä»·</h2><p>é™¤äº†å®ç°å¸¸ç”¨æ•°æ®åº“çš„è¯„ä»·ä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä»¥è¾“å…¥è¾“å‡ºå¯¹è‡ªå®šä¹‰è¯„ä»·æŒ‡æ ‡ï¼Œä»¥å®ä¾‹æ£€æµ‹ä¸ºä¾‹</p>
<pre><code>class Counter(DatasetEvaluator):
  def reset(self):
    self.count = 0
  def process(self, inputs, outputs):
    for output in outputs:
      self.count += len(output["instances"])
  def evaluate(self):
    # save self.count somewhere, or print it, or return it.
    return {"count": self.count}
</code></pre>
<h3 id="11-1-ä½¿ç”¨"><a href="#11-1-ä½¿ç”¨" class="headerlink" title="11.1 ä½¿ç”¨"></a>11.1 ä½¿ç”¨</h3><pre><code>def get_all_inputs_outputs():
  for data in data_loader:
    yield data, model(data)

evaluator.reset()
for inputs, outputs in get_all_inputs_outputs():
  evaluator.process(inputs, outputs)
eval_results = evaluator.evaluate()
</code></pre>
<p>ä¹Ÿå¯ä»¥å°†è¯„ä»·æŒ‡æ ‡ä¸æ•°æ®é›†ç»‘å®š</p>
<pre><code>eval_results = inference_on_dataset(
    model,
    data_loader,
    DatasetEvaluators([COCOEvaluator(...), Counter()]))
</code></pre>
<p>ä¸ä½¿ç”¨æ¨¡å‹æ‰‹åŠ¨è¿è¡Œè¯„ä¼°ç›¸æ¯”ï¼Œæ­¤å‡½æ•°çš„å¥½å¤„åœ¨äºï¼Œå¯ä»¥ä½¿ç”¨DatasetEvaluatorså°†è¯„ä¼°å™¨åˆå¹¶åœ¨ä¸€èµ·ï¼Œå¹¶ä¸”æ‰€æœ‰è¯„ä¼°éƒ½å¯ä»¥åœ¨æ•°æ®é›†çš„ä¸€æ¬¡å‰å‘ä¼ é€’ä¸­å®Œæˆã€‚è¿™ä¸ªå‡½æ•°è¿˜ä¸ºç»™å®šçš„æ¨¡å‹å’Œæ•°æ®é›†æä¾›ç²¾ç¡®çš„é€Ÿåº¦åŸºå‡†ã€‚</p>
<h3 id="11-2-è‡ªå®šä¹‰è¯„ä¼°å™¨"><a href="#11-2-è‡ªå®šä¹‰è¯„ä¼°å™¨" class="headerlink" title="11.2 è‡ªå®šä¹‰è¯„ä¼°å™¨"></a>11.2 è‡ªå®šä¹‰è¯„ä¼°å™¨</h3><p>detectron2ä¸­çš„è®¸å¤šè¯„ä¼°å™¨éƒ½æ˜¯é’ˆå¯¹ç‰¹å®šçš„æ•°æ®é›†ï¼Œä»¥ä¾¿ä½¿ç”¨æ¯ä¸ªæ•°æ®é›†çš„å®˜æ–¹APIè·å¾—åˆ†æ•°ã€‚æ­¤å¤–ï¼Œä»¥ä¸‹ä¸¤ä¸ªè¯„ä¼°å™¨èƒ½å¤Ÿè¯„ä¼°ä»»ä½•é€šç”¨æ•°æ®é›†ï¼Œéµå¾ªdetectron2çš„æ ‡å‡†æ•°æ®é›†æ ¼å¼ï¼Œæ‰€ä»¥ä»–ä»¬å¯ä»¥ç”¨æ¥è¯„ä¼°è‡ªå®šä¹‰æ•°æ®é›†:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/evaluation.html#detectron2.evaluation.COCOEvaluator">COCOEvaluator</a> is able to evaluate AP (Average Precision) for box detection, instance segmentation, keypoint detection on any custom dataset.</li>
<li><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/evaluation.html#detectron2.evaluation.SemSegEvaluator">SemSegEvaluator</a> is able to evaluate semantic segmentation metrics on any custom dataset.</li>
</ul>
<h2 id="12-Yacsé…ç½®æ–‡ä»¶"><a href="#12-Yacsé…ç½®æ–‡ä»¶" class="headerlink" title="12. Yacsé…ç½®æ–‡ä»¶"></a>12. Yacsé…ç½®æ–‡ä»¶</h2><p>Detectron2åŸºäºé”®å€¼å¯¹çš„é…ç½®æ–‡ä»¶ç³»ç»Ÿèƒ½å¤Ÿç”¨æ¥æ‰§è¡Œæ ‡å‡†è¡Œä¸ºã€‚ç³»ç»Ÿä½¿ç”¨YAMLå’Œ<a target="_blank" rel="noopener" href="https://github.com/rbgirshick/yacs">yacs</a>ã€‚å…¶ä¸­Yamlæ˜¯åŠŸèƒ½æ¯”è¾ƒæœ‰é™çš„ä¸€é—¨è¯­è¨€ï¼Œå¹¶ä¸èƒ½å®ç°detectron2çš„æ‰€æœ‰åŠŸèƒ½ï¼Œæ‰€ä»¥æ›´æ¨èä½¿ç”¨detectron2çš„APIã€‚</p>
<h3 id="12-1-åŸºç¡€ä½¿ç”¨"><a href="#12-1-åŸºç¡€ä½¿ç”¨" class="headerlink" title="12.1 åŸºç¡€ä½¿ç”¨"></a>12.1 åŸºç¡€ä½¿ç”¨</h3><pre><code>from detectron2.config import get_cfg
cfg = get_cfg()    # obtain detectron2's default config
cfg.xxx = yyy      # add new configs for your own custom components
cfg.merge_from_file("my_cfg.yaml")   # load values from a file

cfg.merge_from_list(["MODEL.WEIGHTS", "weights.pth"])   # can also load values from a list of str
print(cfg.dump())  # print formatted configs
with open("output.yaml", "w") as f:
  f.write(cfg.dump())   # save config to file
</code></pre>
<p>é™¤äº†åŸºæœ¬çš„Yamlè¯­æ³•å¤–ï¼Œé…ç½®æ–‡ä»¶è¿˜å¯ä»¥å®šä¹‰ä¸€ä¸ª_BASE_: base.yamlã€‚Yamlå­—æ®µï¼Œå®ƒå°†é¦–å…ˆåŠ è½½åŸºæœ¬é…ç½®æ–‡ä»¶ã€‚å¦‚æœæœ‰ä»»ä½•å†²çªï¼ŒåŸºæœ¬é…ç½®ä¸­çš„å€¼å°†åœ¨å­é…ç½®ä¸­è¢«è¦†ç›–ã€‚å®˜æ–¹ä¸ºæ ‡å‡†æ¨¡å‹ä½“ç³»ç»“æ„æä¾›äº†å‡ ä¸ªåŸºæœ¬é…ç½®ã€‚detectron2ä¸­çš„è®¸å¤šå†…ç½®å·¥å…·æ¥å—å‘½ä»¤è¡Œé…ç½®è¦†ç›–:å‘½ä»¤è¡Œä¸­æä¾›çš„é”®å€¼å¯¹å°†è¦†ç›–é…ç½®æ–‡ä»¶ä¸­çš„ç°æœ‰å€¼ã€‚ä¾‹å¦‚ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/facebookresearch/detectron2/blob/main/demo/demo.py">demo.py</a>å¯ä»¥ç”¨äº</p>
<pre><code>./demo.py --config-file config.yaml [--other-options] \
  --opts MODEL.WEIGHTS /path/to/weights INPUT.MIN_SIZE_TEST 1000
</code></pre>
<h3 id="12-2-åœ¨é¡¹ç›®ä¸­é…ç½®"><a href="#12-2-åœ¨é¡¹ç›®ä¸­é…ç½®" class="headerlink" title="12.2 åœ¨é¡¹ç›®ä¸­é…ç½®"></a>12.2 åœ¨é¡¹ç›®ä¸­é…ç½®</h3><p>åœ¨detectron2åº“ä¹‹å¤–çš„é¡¹ç›®å¯ä»¥å®šä¹‰è‡ªå·±çš„configsï¼Œéœ€è¦æ·»åŠ è¿™äº›configsæ‰èƒ½ä½¿é¡¹ç›®å‘æŒ¥ä½œç”¨ï¼Œä¾‹å¦‚:</p>
<pre><code>from detectron2.projects.point_rend import add_pointrend_config
cfg = get_cfg()    # obtain detectron2's default config
add_pointrend_config(cfg)  # add pointrend's default config
# ... ...
</code></pre>
<h3 id="12-3-æœ€ä½³å®è·µ"><a href="#12-3-æœ€ä½³å®è·µ" class="headerlink" title="12.3 æœ€ä½³å®è·µ"></a>12.3 æœ€ä½³å®è·µ</h3><ol>
<li>æŠŠä½ å†™çš„é…ç½®å½“ä½œâ€œä»£ç â€:é¿å…å¤åˆ¶å®ƒä»¬;ä½¿ç”¨_BASE_åœ¨é…ç½®ä¹‹é—´å…±äº«å…¬å…±éƒ¨åˆ†ã€‚</li>
<li>ä¿æŒç¼–å†™çš„é…ç½®ç®€å•:ä¸è¦åŒ…å«ä¸ä¼šå½±å“å®éªŒè®¾ç½®çš„é”®ã€‚</li>
</ol>
<h2 id="13-Lazy-é…ç½®"><a href="#13-Lazy-é…ç½®" class="headerlink" title="13. Lazy é…ç½®"></a>13. Lazy é…ç½®</h2><p>ä¼ ç»Ÿçš„åŸºäºyacsçš„é…ç½®ç³»ç»Ÿæä¾›åŸºæœ¬çš„ã€æ ‡å‡†çš„åŠŸèƒ½ã€‚ç„¶è€Œï¼Œå®ƒä¸èƒ½ä¸ºè®¸å¤šæ–°é¡¹ç›®æä¾›è¶³å¤Ÿçš„çµæ´»æ€§ã€‚Detectron2å¼€å‘äº†ä¸€ä¸ªå¯é€‰çš„ã€éä¾µå…¥æ€§çš„é…ç½®ç³»ç»Ÿï¼Œå¯ç”¨äºdetectron2æˆ–ä»»ä½•å…¶ä»–å¤æ‚é¡¹ç›®ã€‚</p>
<h3 id="13-1-pythonè¯­æ³•"><a href="#13-1-pythonè¯­æ³•" class="headerlink" title="13.1 pythonè¯­æ³•"></a>13.1 pythonè¯­æ³•</h3><p>åŸºäºpythonçš„å­—å…¸è€Œä¸æ˜¯Yamlï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹å¥½å¤„</p>
<ol>
<li>å€ŸåŠ©pythonæ›´å¥½çš„æ“ä½œå­—å…¸ã€‚ï¼ˆå¢åˆ ï¼‰</li>
<li>ç¼–å†™ç®€å•çš„ç»“æ„ä¸å…±èƒ½</li>
<li>ä½¿ç”¨æ›´å¤šçš„æ•°æ®ç±»å‹ä¸ç»“æ„</li>
<li>ä½¿ç”¨Pythonå¯¼å…¥è¯­æ³•å¯¼å…¥/ç»„åˆå…¶ä»–é…ç½®æ–‡ä»¶ã€‚</li>
</ol>
<p>ä½¿ç”¨</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># config.py:</span>
a <span class="token operator">=</span> dict<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> z<span class="token operator">=</span>dict<span class="token punctuation">(</span>xx<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> dict<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># my_code.py:</span>
<span class="token keyword">from</span> detectron2<span class="token punctuation">.</span>config <span class="token keyword">import</span> LazyConfig
cfg <span class="token operator">=</span> LazyConfig<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token string">"path/to/config.py"</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># an omegaconf dictionary</span>
<span class="token keyword">assert</span> cfg<span class="token punctuation">.</span>a<span class="token punctuation">.</span>z<span class="token punctuation">.</span>xx <span class="token operator">==</span> <span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨<a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyConfig.load">LazyConfig.load</a>åï¼Œcfgå°±æˆä¸ºä¸€ä¸ªåŒ…å«å®šä¹‰åœ¨å…¨å±€ä¸Šçš„æ‰€æœ‰å­—å…¸ä¿¡æ¯çš„å­—å…¸ã€‚éœ€è¦æ³¨æ„çš„æ˜¯</p>
<ul>
<li>All dictionaries are turned to an <a target="_blank" rel="noopener" href="https://omegaconf.readthedocs.io/">omegaconf</a> config object during loading. This enables access to omegaconf features, such as its <a target="_blank" rel="noopener" href="https://omegaconf.readthedocs.io/en/2.1_branch/usage.html#access-and-manipulation">access syntax</a> and <a target="_blank" rel="noopener" href="https://omegaconf.readthedocs.io/en/2.1_branch/usage.html#variable-interpolation">interpolation</a>.</li>
<li>Absolute imports in <code>config.py</code> works the same as in regular Python.</li>
<li>Relative imports can only import dictionaries from config files. They are simply a syntax sugar for <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyConfig.load_rel">LazyConfig.load_rel</a>. They can load Python files at relative path without requiring <code>__init__.py</code>.</li>
</ul>
<p>ï¼ˆç»å¯¹/ç›¸å¯¹å¼•å…¥æ˜¯ä»€ä¹ˆï¼Ÿï¼‰</p>
<p><a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyConfig.save">LazyConfig.save</a>å¯ä»¥å°†é…ç½®å¯¹è±¡ä¿å­˜åˆ°yamlã€‚æ³¨æ„ï¼Œï¼Œè¿™å¹¶ä¸æ€»æ˜¯æœ€æœ‰æ•ˆçš„ï¼Œå¦‚æœé…ç½®æ–‡ä»¶ä¸­å‡ºç°äº†ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡(ä¾‹å¦‚lambdas)ã€‚ç”¨æˆ·è‡ªè¡Œå†³å®šæ˜¯å¦ç‰ºç‰²èŠ‚çœçš„èƒ½åŠ›æ¥æ¢å–çµæ´»æ€§ã€‚</p>
<h3 id="13-2-é€’å½’çš„å®ä¾‹åŒ–"><a href="#13-2-é€’å½’çš„å®ä¾‹åŒ–" class="headerlink" title="13.2 é€’å½’çš„å®ä¾‹åŒ–"></a>13.2 é€’å½’çš„å®ä¾‹åŒ–</h3><p>We provide a helper function <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.LazyCall">LazyCall</a> that helps create such dictionaries. The following code using <code>LazyCall</code></p>
<pre><code>from detectron2.config import LazyCall as L
from my_app import Trainer, Optimizer
cfg = L(Trainer)(
  optimizer=L(Optimizer)(
    lr=0.01,
    algo="SGD"
  )
)
</code></pre>
<p>creates a dictionary like this:</p>
<pre><code>cfg = {
  "_target_": "my_app.Trainer",
  "optimizer": {
    "_target_": "my_app.Optimizer",
    "lr": 0.01, "algo": "SGD"
  }
}
</code></pre>
<p>By representing objects using such dictionaries, a general <a target="_blank" rel="noopener" href="https://detectron2.readthedocs.io/en/latest/modules/config.html#detectron2.config.instantiate">instantiate</a> function can turn them into actual objects, i.e.:</p>
<pre><code>from detectron2.config import instantiate
trainer = instantiate(cfg)
# equivalent to:
# from my_app import Trainer, Optimizer
# trainer = Trainer(optimizer=Optimizer(lr=0.01, algo="SGD"))
</code></pre>
<p>This pattern is powerful enough to describe very complex objects, e.g.:</p>
<p>A Full Mask R-CNN described in recursive instantiation</p>
<pre><code>from detectron2.config import LazyCall as L
from detectron2.layers import ShapeSpec
from detectron2.modeling.meta_arch import GeneralizedRCNN
from detectron2.modeling.anchor_generator import DefaultAnchorGenerator
from detectron2.modeling.backbone.fpn import LastLevelMaxPool
from detectron2.modeling.backbone import BasicStem, FPN, ResNet
from detectron2.modeling.box_regression import Box2BoxTransform
from detectron2.modeling.matcher import Matcher
from detectron2.modeling.poolers import ROIPooler
from detectron2.modeling.proposal_generator import RPN, StandardRPNHead
from detectron2.modeling.roi_heads import (
    StandardROIHeads,
    FastRCNNOutputLayers,
    MaskRCNNConvUpsampleHead,
    FastRCNNConvFCHead,
)

model = L(GeneralizedRCNN)(
    backbone=L(FPN)(
        bottom_up=L(ResNet)(
            stem=L(BasicStem)(in_channels=3, out_channels=64, norm="FrozenBN"),
            stages=L(ResNet.make_default_stages)(
                depth=50,
                stride_in_1x1=True,
                norm="FrozenBN",
            ),
            out_features=["res2", "res3", "res4", "res5"],
        ),
        in_features="${.bottom_up.out_features}",
        out_channels=256,
        top_block=L(LastLevelMaxPool)(),
    ),
    proposal_generator=L(RPN)(
        in_features=["p2", "p3", "p4", "p5", "p6"],
        head=L(StandardRPNHead)(in_channels=256, num_anchors=3),
        anchor_generator=L(DefaultAnchorGenerator)(
            sizes=[[32], [64], [128], [256], [512]],
            aspect_ratios=[0.5, 1.0, 2.0],
            strides=[4, 8, 16, 32, 64],
            offset=0.0,
        ),
        anchor_matcher=L(Matcher)(
            thresholds=[0.3, 0.7], labels=[0, -1, 1], allow_low_quality_matches=True
        ),
        box2box_transform=L(Box2BoxTransform)(weights=[1.0, 1.0, 1.0, 1.0]),
        batch_size_per_image=256,
        positive_fraction=0.5,
        pre_nms_topk=(2000, 1000),
        post_nms_topk=(1000, 1000),
        nms_thresh=0.7,
    ),
    roi_heads=L(StandardROIHeads)(
        num_classes=80,
        batch_size_per_image=512,
        positive_fraction=0.25,
        proposal_matcher=L(Matcher)(
            thresholds=[0.5], labels=[0, 1], allow_low_quality_matches=False
        ),
        box_in_features=["p2", "p3", "p4", "p5"],
        box_pooler=L(ROIPooler)(
            output_size=7,
            scales=(1.0 / 4, 1.0 / 8, 1.0 / 16, 1.0 / 32),
            sampling_ratio=0,
            pooler_type="ROIAlignV2",
        ),
        box_head=L(FastRCNNConvFCHead)(
            input_shape=ShapeSpec(channels=256, height=7, width=7),
            conv_dims=[],
            fc_dims=[1024, 1024],
        ),
        box_predictor=L(FastRCNNOutputLayers)(
            input_shape=ShapeSpec(channels=1024),
            test_score_thresh=0.05,
            box2box_transform=L(Box2BoxTransform)(weights=(10, 10, 5, 5)),
            num_classes="${..num_classes}",
        ),
        mask_in_features=["p2", "p3", "p4", "p5"],
        mask_pooler=L(ROIPooler)(
            output_size=14,
            scales=(1.0 / 4, 1.0 / 8, 1.0 / 16, 1.0 / 32),
            sampling_ratio=0,
            pooler_type="ROIAlignV2",
        ),
        mask_head=L(MaskRCNNConvUpsampleHead)(
            input_shape=ShapeSpec(channels=256, width=14, height=14),
            num_classes="${..num_classes}",
            conv_dims=[256, 256, 256, 256, 256],
        ),
    ),
    pixel_mean=[103.530, 116.280, 123.675],
    pixel_std=[1.0, 1.0, 1.0],
    input_format="BGR",
)
</code></pre>
<p>There are also objects or logic that cannot be described simply by a dictionary, such as reused objects or method calls. They may require some refactoring to work with recursive instantiation.</p>
<h3 id="13-3-ä½¿ç”¨Model-Zoo-LazyConfigs"><a href="#13-3-ä½¿ç”¨Model-Zoo-LazyConfigs" class="headerlink" title="13.3 ä½¿ç”¨Model Zoo LazyConfigs"></a>13.3 ä½¿ç”¨Model Zoo LazyConfigs</h3><h3 id="13-4-æ€»ç»“"><a href="#13-4-æ€»ç»“" class="headerlink" title="13.4 æ€»ç»“"></a>13.4 æ€»ç»“</h3><h2 id="14-éƒ¨ç½²"><a href="#14-éƒ¨ç½²" class="headerlink" title="14. éƒ¨ç½²"></a>14. éƒ¨ç½²</h2><p>ç”¨Pythonç¼–å†™çš„æ¨¡å‹éœ€è¦ç»è¿‡å¯¼å‡ºè¿‡ç¨‹æ‰èƒ½æˆä¸ºå¯éƒ¨ç½²çš„æ„ä»¶ã€‚å…³äºè¿™ä¸ªè¿‡ç¨‹çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ:</p>
<p>â€œå¯¼å‡ºæ–¹æ³•â€æ˜¯å°†Pythonæ¨¡å‹å®Œå…¨åºåˆ—åŒ–ä¸ºå¯éƒ¨ç½²æ ¼å¼çš„æ–¹å¼ã€‚Detectron2æ”¯æŒä»¥ä¸‹å¯¼å‡ºæ–¹å¼:</p>
<ul>
<li><code>tracing</code>: see <a target="_blank" rel="noopener" href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html">pytorch documentation</a> to learn about it</li>
<li><code>scripting</code>: see <a target="_blank" rel="noopener" href="https://pytorch.org/tutorials/beginner/Intro_to_TorchScript_tutorial.html">pytorch documentation</a> to learn about it</li>
<li><code>caffe2_tracing</code>: replace parts of the model by caffe2 operators, then use tracing.(å°†è¦è¢«èˆå¼ƒï¼Œä¸å»ºè®®ä½¿ç”¨)</li>
</ul>
<table>
<thead>
<tr>
<th>Export Method</th>
<th>tracing</th>
<th>scripting</th>
<th>caffe2_tracing</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Formats</strong></td>
<td>TorchScript</td>
<td>TorchScript</td>
<td>Caffe2, TorchScript, ONNX</td>
</tr>
<tr>
<td><strong>Runtime</strong></td>
<td>PyTorch</td>
<td>PyTorch</td>
<td>Caffe2, PyTorch</td>
</tr>
<tr>
<td>C++/Python inference</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Dynamic resolution</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>Batch size requirement</td>
<td>Constant</td>
<td>Dynamic</td>
<td>Batch inference unsupported</td>
</tr>
<tr>
<td>Extra runtime deps</td>
<td>torchvision</td>
<td>torchvision</td>
<td>Caffe2 ops (usually alreadyincluded in PyTorch)</td>
</tr>
<tr>
<td>Faster/Mask/Keypoint R-CNN</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>RetinaNet</td>
<td>âœ…</td>
<td>âœ…</td>
<td>âœ…</td>
</tr>
<tr>
<td>PointRend R-CNN</td>
<td>âœ…</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
<tr>
<td>Cascade R-CNN</td>
<td>âœ…</td>
<td>âŒ</td>
<td>âŒ</td>
</tr>
</tbody></table>
<p><strong>â€œFormatâ€</strong> is how a serialized model is described in a file, e.g. TorchScript, Caffe2 protobuf, ONNX format. <strong>â€œRuntimeâ€</strong> is an engine that loads a serialized model and executes it, e.g., PyTorch, Caffe2, TensorFlow, onnxruntime, TensorRT, etc. A runtime is often tied to a specific format (e.g. PyTorch needs TorchScript format, Caffe2 needs protobuf format). We currently support the following combination and each has some limitations:</p>
<p><code>caffe2_tracing</code> is going to be deprecated. We donâ€™t plan to work on additional support for other formats/runtime, but contributions are welcome.</p>
<h3 id="14-1-ä½¿ç”¨Tracingæˆ–Scriptingè¿›è¡Œéƒ¨ç½²"><a href="#14-1-ä½¿ç”¨Tracingæˆ–Scriptingè¿›è¡Œéƒ¨ç½²" class="headerlink" title="14.1 ä½¿ç”¨Tracingæˆ–Scriptingè¿›è¡Œéƒ¨ç½²"></a>14.1 ä½¿ç”¨Tracingæˆ–Scriptingè¿›è¡Œéƒ¨ç½²</h3><p>æ¨¡å‹å¯ä»¥é€šè¿‡Tracingæˆ–Scriptingå¯¼å‡ºä¸ºTorchScriptæ ¼å¼ã€‚åœ¨Pythonæˆ–c++ä¸­ï¼Œè¾“å‡ºæ¨¡å‹æ–‡ä»¶å¯ä»¥åœ¨ä¸ä¾èµ–äºdetectron2çš„æƒ…å†µä¸‹åŠ è½½ã€‚å¯¼å‡ºçš„æ¨¡å‹é€šå¸¸éœ€è¦å¯¹ä¸€äº›è‡ªå®šä¹‰æ“ä½œçš„torchvision(æˆ–å…¶c++åº“)ä¾èµ–ã€‚</p>
<p>è¯¥åŠŸèƒ½è¦æ±‚PyTorchâ‰¥1.8ã€‚</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        æ–‡ç« ä½œè€…:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">W TJ</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        æ–‡ç« é“¾æ¥:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/2021/12/30/detectron2/">http://example.com/2021/12/30/detectron2/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        ç‰ˆæƒå£°æ˜:
                    </i>
                </span>
                <span class="reprint-info">
                    æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº
                    <a href="/about" target="_blank">W TJ</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>å¤åˆ¶æˆåŠŸï¼Œè¯·éµå¾ªæœ¬æ–‡çš„è½¬è½½è§„åˆ™</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">æŸ¥çœ‹</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/">
                                    <span class="chip bg-color">æ·±åº¦å­¦ä¹ </span>
                                </a>
                            
                                <a href="/tags/Detectron2/">
                                    <span class="chip bg-color">Detectron2</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>å¾®ä¿¡æ‰«ä¸€æ‰«å³å¯åˆ†äº«ï¼</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">èµ</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">ä½ çš„èµè¯†æ˜¯æˆ‘å‰è¿›çš„åŠ¨åŠ›</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">æ”¯ä»˜å®</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">å¾® ä¿¡</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="æ”¯ä»˜å®æ‰“èµäºŒç»´ç ">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="å¾®ä¿¡æ‰“èµäºŒç»´ç ">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;ä¸Šä¸€ç¯‡</div>
            <div class="card">
                <a href="/2021/12/30/bo-ke-ji-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="åšå®¢è®¡åˆ’">
                        
                        <span class="card-title">åšå®¢è®¡åˆ’</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2021-12-30
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            W TJ
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%AE%A1%E5%88%92/">
                        <span class="chip bg-color">è®¡åˆ’</span>
                    </a>
                    
                    <a href="/tags/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">
                        <span class="chip bg-color">åšå®¢æ­å»º</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                ä¸‹ä¸€ç¯‡&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/12/27/dockerh-gua-zai-zong-jie/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="DockerhæŒ‚è½½æ€»ç»“">
                        
                        <span class="card-title">DockerhæŒ‚è½½æ€»ç»“</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2021-12-27
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            W TJ
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Docker/">
                        <span class="chip bg-color">Docker</span>
                    </a>
                    
                    <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%B7%A5%E5%85%B7/">
                        <span class="chip bg-color">è®¡ç®—æœºå·¥å…·</span>
                    </a>
                    
                    <a href="/tags/%E8%BD%AC%E8%BD%BD/">
                        <span class="chip bg-color">è½¬è½½</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- ä»£ç å—åŠŸèƒ½ä¾èµ– -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- ä»£ç è¯­è¨€ -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- ä»£ç å—å¤åˆ¶ -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- ä»£ç å—æ”¶ç¼© -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;ç›®å½•</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC æ‚¬æµ®æŒ‰é’®. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* ä¿®å¤æ–‡ç« å¡ç‰‡ div çš„å®½åº¦. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // åˆ‡æ¢TOCç›®å½•å±•å¼€æ”¶ç¼©çš„ç›¸å…³æ“ä½œ.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2021-2022</span>
            
            <a href="/about" target="_blank">W TJ</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;æ€»è®¿é—®é‡:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;æ€»è®¿é—®äººæ•°:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- è¿è¡Œå¤©æ•°æé†’. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/wangxiatian" class="tooltipped" target="_blank" data-tooltip="è®¿é—®æˆ‘çš„GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:961717731@qq.com" class="tooltipped" target="_blank" data-tooltip="é‚®ä»¶è”ç³»æˆ‘" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=961717731" class="tooltipped" target="_blank" data-tooltip="QQè”ç³»æˆ‘: 961717731" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS è®¢é˜…" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- æœç´¢é®ç½©æ¡† -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;æœç´¢</span>
            <input type="search" id="searchInput" name="s" placeholder="è¯·è¾“å…¥æœç´¢çš„å…³é”®å­—"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- å›åˆ°é¡¶éƒ¨æŒ‰é’® -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    

    <!-- é›ªèŠ±ç‰¹æ•ˆ -->
    

    <!-- é¼ æ ‡æ˜Ÿæ˜Ÿç‰¹æ•ˆ -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--è…¾è®¯å…”å°å·¢-->
    
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
